<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ğŸŒ Regina ç’°çƒèµ°è·³ ğŸ‘£</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS & Tesseract -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#FF6B6B">

  <!-- Dynamic Icon Targets -->
  <link id="app-icon" rel="apple-touch-icon" href="">
  <link id="fav-icon" rel="icon" type="image/png" href="">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Hi+Melody&display=swap');
    
    body { 
      font-family: 'Gaegu', cursive; 
      background-color: #E0F7FA; 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior-y: none; 
      user-select: none;
      font-weight: 700;
      color: #2d3436;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); background-color: #FF6B6B; }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 20px); background-color: white; }
    
    .korean-3d-btn { transition: all 0.1s; box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.15); transform: translateY(0); }
    .korean-3d-btn:active { transform: translateY(3px); box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.15); }
    
    .font-thin-hand { font-family: 'Gaegu', cursive; font-weight: 300 !important; }
    
    .paper-texture { background-color: #fffbf0; background-image: radial-gradient(#d4c5a6 0.8px, transparent 0.8px); background-size: 12px 12px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    input, select, textarea { font-size: 18px !important; font-family: 'Gaegu', cursive; font-weight: 700; }
    
    .snap-x-mandatory { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .loading-spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Print Styles for Booklet */
    @media print {
      body * { visibility: hidden; }
      #printable-booklet, #printable-booklet * { visibility: visible; }
      #printable-booklet { 
        position: absolute; 
        left: 0; 
        top: 0; 
        width: 100%; 
        min-height: 100vh;
        background: white; 
        z-index: 9999;
        overflow: visible;
      }
      .no-print { display: none !important; }
      .page-break { break-before: page; }
      .print-shadow-none { box-shadow: none !important; }
      .print-border-black { border-color: black !important; }
    }
  </style>
</head>
<body class="overflow-hidden bg-[#E0F7FA]">
  <div id="root" class="h-full w-full"></div>

  <!-- Icon Generation (V38: New Pink Design) -->
  <script>
    window.addEventListener('load', function() {
      // Check if user uploaded a custom icon, otherwise use the new V38 Pink Design
      const savedIcon = localStorage.getItem('crab_app_icon_v37');
      if (savedIcon) {
          document.getElementById('app-icon').href = savedIcon; 
          document.getElementById('fav-icon').href = savedIcon;
      } else {
          try {
            // V38 New Icon: Warm Pink Background + Plane + Suitcase
            const svgString = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <!-- Background: Warm Pink -->
              <rect width="512" height="512" fill="#FFC1C1" />
              
              <!-- Soft White Circle Background for contrast -->
              <circle cx="256" cy="256" r="220" fill="white" opacity="0.3"/>

              <!-- Suitcase (Bottom Center) -->
              <g transform="translate(136, 180)">
                <rect x="20" y="40" width="200" height="160" rx="20" fill="#8D6E63" stroke="white" stroke-width="10"/>
                <rect x="20" y="40" width="200" height="50" rx="20" fill="#6D4C41" />
                <!-- Handle -->
                <path d="M90 40 V 10 A 10 10 0 0 1 150 10 V 40" fill="none" stroke="#5D4037" stroke-width="15" stroke-linecap="round"/>
                <!-- Straps -->
                <rect x="60" y="40" width="20" height="160" fill="#5D4037" opacity="0.4"/>
                <rect x="160" y="40" width="20" height="160" fill="#5D4037" opacity="0.4"/>
                <!-- Stickers -->
                <circle cx="180" cy="160" r="15" fill="#FFAB91"/>
                <rect x="50" y="140" width="30" height="20" fill="#80CBC4" transform="rotate(-10 65 150)"/>
              </g>

              <!-- Airplane (Flying Above) -->
              <g transform="translate(180, 80) rotate(-15)">
                <path d="M20 60 L 100 60 L 130 20 L 150 20 L 120 60 L 180 60 C 200 60 200 80 180 80 L 120 80 L 150 120 L 130 120 L 100 80 L 20 80 C 0 80 0 60 20 60 Z" fill="white" stroke="#FF8A80" stroke-width="5"/>
              </g>

              <!-- Decorative Elements -->
              <circle cx="80" cy="400" r="20" fill="white" opacity="0.6"/>
              <circle cx="450" cy="100" r="15" fill="white" opacity="0.6"/>
              <path d="M400 400 Q 450 350 480 400" fill="none" stroke="white" stroke-width="8" stroke-linecap="round" opacity="0.5"/>
            </svg>`;
            
            const canvas = document.createElement('canvas'); 
            canvas.width = 512; 
            canvas.height = 512;
            const ctx = canvas.getContext('2d'); 
            const img = new Image(); 
            img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
            
            img.onload = function() { 
                ctx.drawImage(img, 0, 0); 
                const pngUrl = canvas.toDataURL('image/png'); 
                document.getElementById('app-icon').href = pngUrl; 
                document.getElementById('fav-icon').href = pngUrl; 
            };
          } catch(e) { console.warn("Icon gen failed", e); }
      }
    });
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Icons ---
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      ShoppingBag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Map: (p) => <Icon {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Coins: (p) => <Icon {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>,
      Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
      X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
      FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
      Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
      Refresh: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>,
      Navigation: (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Loader: (p) => <Icon {...p}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></Icon>,
      Image: (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>,
      Suitcase: (p) => <Icon {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
      Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      Utensils: (p) => <Icon {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      ListPlus: (p) => <Icon {...p}><path d="M11 12H3"/><path d="M16 6H3"/><path d="M16 18H3"/><path d="M18 9v6"/><path d="M21 12h-6"/></Icon>,
      Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
      CloudSun: (p) => <Icon {...p}><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></Icon>,
      ArrowUp: (p) => <Icon {...p}><path d="m18 15-6-6-6 6"/></Icon>,
      ArrowDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
      Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
      User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
      Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></Icon>,
      PlusCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></Icon>,
      BookOpen: (p) => <Icon {...p}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></Icon>,
      Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
      Plane: (p) => <Icon {...p}><path d="M2 12h20"/><path d="M13 12l3-7h3l-4 7h3l1 7h-3l-2-7h-3z"/><path d="M22 22h-2"/><path d="M2 22H0"/></Icon>,
      Bed: (p) => <Icon {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></Icon>,
      Notebook: (p) => <Icon {...p}><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M16 2v20"/></Icon>,
      Globe: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>,
      Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>,
    };

    // --- Refactored Currencies with Explicit Flag Property ---
    const CURRENCIES = [
        { code: 'TWD', name: 'å°å¹£', flag: 'ğŸ‡¹ğŸ‡¼', symbol: '$', defaultRate: 1 },
        { code: 'JPY', name: 'æ—¥å¹£', flag: 'ğŸ‡¯ğŸ‡µ', symbol: 'Â¥', defaultRate: 0.215 },
        { code: 'USD', name: 'ç¾é‡‘', flag: 'ğŸ‡ºğŸ‡¸', symbol: '$', defaultRate: 31.5 },
        { code: 'GBP', name: 'è‹±éŠ', flag: 'ğŸ‡¬ğŸ‡§', symbol: 'Â£', defaultRate: 40.5 },
        { code: 'EUR', name: 'æ­å…ƒ', flag: 'ğŸ‡ªğŸ‡º', symbol: 'â‚¬', defaultRate: 34.2 },
        { code: 'KRW', name: 'éŸ“å…ƒ', flag: 'ğŸ‡°ğŸ‡·', symbol: 'â‚©', defaultRate: 0.024 },
        { code: 'THB', name: 'æ³°éŠ–', flag: 'ğŸ‡¹ğŸ‡­', symbol: 'à¸¿', defaultRate: 0.9 },
        { code: 'AUD', name: 'æ¾³å¹£', flag: 'ğŸ‡¦ğŸ‡º', symbol: '$', defaultRate: 20.8 },
        { code: 'CAD', name: 'åŠ å¹£', flag: 'ğŸ‡¨ğŸ‡¦', symbol: '$', defaultRate: 23.2 },
        { code: 'SGD', name: 'æ–°å¹£', flag: 'ğŸ‡¸ğŸ‡¬', symbol: '$', defaultRate: 23.5 },
        { code: 'VND', name: 'è¶Šå—ç›¾', flag: 'ğŸ‡»ğŸ‡³', symbol: 'â‚«', defaultRate: 0.0013 },
        { code: 'MYR', name: 'é¦¬å¹£', flag: 'ğŸ‡²ğŸ‡¾', symbol: 'RM', defaultRate: 7.5 },
    ];

    // --- Data ---
    const INITIAL_ITINERARY = [
      { 
        id: 1, date: '2026-02-02', weekday: 'æ—¥', 
        content: '', transport: 'åé–€å¤§æ´‹æ¸¡è¼ª', stay: 'èˆ¹ä¸Š', food: 'èˆ¹ä¸Šè‡ªåŠ©é¤', highlights: 'æ¬£è³ç€¨æˆ¶å…§æµ·å¤œæ™¯', photo: null,
        schedule: [
            { id: 101, time: '15:00', category: 'äº¤é€š', activity: 'å‰å¾€å—æ¸¯æ¸¡è¼ªç«™', note: 'ææ—©check-in' },
            { id: 102, time: '17:00', category: 'äº¤é€š', activity: 'åé–€å¤§æ´‹æ¸¡è¼ª å‡ºç™¼', note: 'æ¬£è³å¤•é™½' }
        ]
      },
      { 
        id: 2, date: '2026-02-03', weekday: 'ä¸€', 
        content: '', transport: 'JR / æ­¥è¡Œ', stay: 'ç¦å²¡ Quintessa', food: 'ç‡’å’–å“©', highlights: 'æ‡·èˆŠå»ºç¯‰ã€å°å€‰åŸ', photo: null,
        schedule: [
            { id: 201, time: '08:30', category: 'äº¤é€š', activity: 'æŠµé”é–€å¸æ¸¯', note: 'ä¸‹èˆ¹' },
            { id: 202, time: '10:00', category: 'æ™¯é»', activity: 'é–€å¸æ¸¯æ‡·èˆŠå€', note: 'æ‹ç…§' }
        ]
      },
    ];

    const INITIAL_SHOPPING = [
      { id: 1, item: 'åˆåˆ©ä»–å‘½', budget: 5000, currency: 'JPY', bought: false, store: 'æ¾æœ¬æ¸…', priority: 'high', type: 'self', note: '' },
    ];
    
    const INITIAL_PACKING_CATEGORIES = ['é‡è¦è­‰ä»¶ & éš¨èº«', 'æ´—æ¼± & è­·ç†', 'é†«è—¥ & ä¿å¥', 'ç¾å¦ & ä¿é¤Š', 'è¡£ç‰© & ç©¿æ­', 'é›»å­ & é›œç‰©'];

    const INITIAL_PACKING_LIST = [
        { id: 101, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'è­·ç…§ / ç°½è­‰', checked: false },
        { id: 102, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'æ©Ÿç¥¨ / æ†‘è­‰ (VJWæˆªåœ–)', checked: false },
        { id: 103, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'éŒ¢åŒ… (ç¾é‡‘/ä¿¡ç”¨å¡)', checked: false },
        { id: 104, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'è¡Œå‹•é›»æº', checked: false },
        { id: 501, category: 'è¡£ç‰© & ç©¿æ­', item: 'æ›æ´—è¡£ç‰©', checked: false },
    ];
    
    const INITIAL_MEMOS = [
        { id: 1, date: '2026-02-02', category: 'flight', title: 'æ˜Ÿå®‡èˆªç©º JX821', bookingRef: 'ABC12345', seat: '12A', content: 'ç¬¬ä¸€èˆªå»ˆå ±åˆ°' },
        { id: 2, date: '2026-02-03', category: 'hotel', title: 'Quintessa Hotel', address: 'ç¦å²¡çœŒç¦å²¡å¸‚...', bookingRef: 'HTL-998877', content: 'å«æ—©é¤' }
    ];

    // Updated Categories Logic
    const MEMO_SECTIONS = [
        { id: 'flight', label: 'èˆªç­äº¤é€š', icon: <Icons.Plane size={24}/>, color: 'border-blue-400', bg: 'bg-blue-50', text: 'text-blue-600' },
        { id: 'hotel', label: 'ä½å®¿æ†‘è­‰', icon: <Icons.Bed size={24}/>, color: 'border-indigo-400', bg: 'bg-indigo-50', text: 'text-indigo-600' },
        { id: 'food', label: 'ç¾é£Ÿå£è¢‹', icon: <Icons.Utensils size={24}/>, color: 'border-orange-400', bg: 'bg-orange-50', text: 'text-orange-600' },
        { id: 'note', label: 'è‡ªç”±ç­†è¨˜', icon: <Icons.Notebook size={24}/>, color: 'border-gray-400', bg: 'bg-gray-50', text: 'text-gray-600' },
    ];

    const INITIAL_PAYMENT_METHODS = ['ç¾é‡‘', 'ä¿¡ç”¨å¡(ä¸­ä¿¡)', 'ä¿¡ç”¨å¡(å¯Œé‚¦J)', 'è¥¿ç“œå¡'];
    const INITIAL_BOOKING_PLATFORMS = ['ç¾å ´', 'Agoda', 'Booking', 'å®˜ç¶²', 'Klook', 'æ±æ©«INN'];
    const CATEGORIES = ['ğŸœ é£²é£Ÿ', 'ğŸšƒ äº¤é€š', 'ğŸ¨ ä½å®¿', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ« é–€ç¥¨', 'ğŸ“ å…¶ä»–'];
    const SCHEDULE_CATEGORIES = [
        { name: 'æ™¯é»', color: '#E64A19' },
        { name: 'åƒé£¯', color: '#F57C00' },
        { name: 'é€›è¡—', color: '#C2185B' },
        { name: 'äº¤é€š', color: '#455A64' },
        { name: 'ä½å®¿', color: '#303F9F' },
        { name: 'å½ˆæ€§', color: '#00796B' },
    ];

    const BUTTON_COLORS = ['#FF9F43', '#4ECDC4', '#FF6B6B', '#6C5CE7', '#FFA502'];

    // --- Weather Component ---
    const WeatherWidget = () => {
        const [weather, setWeather] = useState(null);
        const [time, setTime] = useState(new Date());

        useEffect(() => {
            const timer = setInterval(() => setTime(new Date()), 60000);
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.6937&longitude=135.5023&current_weather=true');
                    const data = await res.json();
                    setWeather(data.current_weather);
                } catch (e) { console.warn("Weather fetch failed"); }
            };
            fetchWeather();
            return () => clearInterval(timer);
        }, []);

        return (
            <div className="flex gap-2 items-center text-white text-xs font-bold bg-black/20 rounded-lg px-2 py-1">
                <span>{time.getHours().toString().padStart(2,'0')}:{time.getMinutes().toString().padStart(2,'0')}</span>
                <span className="w-[1px] h-3 bg-white/50"></span>
                <span>{weather ? `${weather.temperature}Â°C` : '...'}</span>
            </div>
        );
    };

    // --- Main App ---
    function App() {
      // Keys
      const loadState = (key, defaultVal) => {
        try { 
            const val = localStorage.getItem(key);
            if (val === null) return defaultVal;
            const parsed = JSON.parse(val);
            if (Array.isArray(defaultVal) && !Array.isArray(parsed)) return defaultVal;
            return parsed;
        } catch (e) { return defaultVal; }
      };

      const saveState = (key, value) => {
          try { localStorage.setItem(key, JSON.stringify(value)); } 
          catch (e) { console.warn("Storage Full", e); }
      };

      const [activeTab, setActiveTab] = useState('itinerary');
      
      const [itinerary, setItinerary] = useState(() => loadState('crab_itinerary_v38', INITIAL_ITINERARY));
      const [expenses, setExpenses] = useState(() => loadState('crab_expenses_v38', []));
      const [shoppingList, setShoppingList] = useState(() => loadState('crab_shopping_v38', INITIAL_SHOPPING));
      const [packingList, setPackingList] = useState(() => loadState('crab_packing_v38', INITIAL_PACKING_LIST));
      const [packingCategories, setPackingCategories] = useState(() => loadState('crab_packing_cats_v38', INITIAL_PACKING_CATEGORIES));
      const [paymentMethods, setPaymentMethods] = useState(() => loadState('crab_methods_v38', INITIAL_PAYMENT_METHODS));
      const [bookingPlatforms, setBookingPlatforms] = useState(() => loadState('crab_platforms_v38', INITIAL_BOOKING_PLATFORMS));
      const [memos, setMemos] = useState(() => loadState('crab_memos_v38', INITIAL_MEMOS));
      const [appIcon, setAppIcon] = useState(() => loadState('crab_app_icon_v38', null)); // Custom App Icon
      
      // Initialize rates
      const initialRates = {};
      CURRENCIES.forEach(c => initialRates[`${c.code}_TWD`] = c.defaultRate);
      
      const [budgetSettings, setBudgetSettings] = useState(() => {
          const saved = loadState('crab_budget_v38', null);
          if (saved) {
              return { ...saved, rates: { ...initialRates, ...saved.rates } };
          }
          return { totalTWD: 50000, startDate: '2026-02-02', rates: initialRates };
      });

      // UI States
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showBatchModal, setShowBatchModal] = useState(false);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [showPlatformManager, setShowPlatformManager] = useState(false);
      const [showBooklet, setShowBooklet] = useState(false); // Booklet Mode
      const [batchType, setBatchType] = useState(null); 
      const [batchText, setBatchText] = useState('');
      const [expenseFilter, setExpenseFilter] = useState('all');
      const [currentDayIndex, setCurrentDayIndex] = useState(0);
      const dayScrollRef = useRef(null);
      const [isScanning, setIsScanning] = useState(false);
      const [scanType, setScanType] = useState(null); 
      const fileInputRef = useRef(null);
      const iconInputRef = useRef(null); // Ref for icon upload
      const [targetDayId, setTargetDayId] = useState(null);
      const [newPackingItemText, setNewPackingItemText] = useState('');
      const [activePackingCategory, setActivePackingCategory] = useState(null);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [editingScheduleId, setEditingScheduleId] = useState(null);
      const [newPlatformName, setNewPlatformName] = useState('');
      
      // Memo Input State
      const [newMemo, setNewMemo] = useState({ date: '2026-02-02', category: '', title: '', content: '', bookingRef: '', seat: '', address: '', image: null });
      const [activeMemoSection, setActiveMemoSection] = useState(null); // For modal/input

      // Pending Shopping Checkout State
      const [pendingShopItemId, setPendingShopItemId] = useState(null);

      // Persistence
      useEffect(() => { saveState('crab_itinerary_v38', itinerary); }, [itinerary]);
      useEffect(() => { saveState('crab_expenses_v38', expenses); }, [expenses]);
      useEffect(() => { saveState('crab_shopping_v38', shoppingList); }, [shoppingList]);
      useEffect(() => { saveState('crab_packing_v38', packingList); }, [packingList]);
      useEffect(() => { saveState('crab_packing_cats_v38', packingCategories); }, [packingCategories]);
      useEffect(() => { saveState('crab_methods_v38', paymentMethods); }, [paymentMethods]);
      useEffect(() => { saveState('crab_platforms_v38', bookingPlatforms); }, [bookingPlatforms]);
      useEffect(() => { saveState('crab_budget_v38', budgetSettings); }, [budgetSettings]);
      useEffect(() => { saveState('crab_memos_v38', memos); }, [memos]);
      useEffect(() => { saveState('crab_app_icon_v38', appIcon); }, [appIcon]); // Persist icon

      const [newExpense, setNewExpense] = useState({ date: itinerary[0]?.date || '', item: '', amount: '', currency: 'JPY', category: 'ğŸœ é£²é£Ÿ', method: paymentMethods[0], platform: bookingPlatforms[0], note: '' });
      const [newShopItem, setNewShopItem] = useState({ item: '', budget: '', currency: 'JPY', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });

      const formatDate = (dateStr) => { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth()+1}/${d.getDate()}`; };
      const getWeekday = (dateStr) => { const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; return days[new Date(dateStr).getDay()]; };

      const updateItineraryDates = () => {
          if (!budgetSettings.startDate) return;
          const start = new Date(budgetSettings.startDate);
          const newItinerary = itinerary.map((item, index) => {
              const d = new Date(start); d.setDate(start.getDate() + index);
              return { ...item, date: d.toISOString().split('T')[0], weekday: getWeekday(d.toISOString().split('T')[0]) };
          });
          setItinerary(newItinerary); alert('è¡Œç¨‹æ—¥æœŸå·²å…¨éƒ¨æ›´æ–°ï¼');
      };

      const getExchangeRate = (currencyCode) => { return budgetSettings?.rates?.[`${currencyCode}_TWD`] || 1; };

      const getDailyTotal = (date) => {
        const dailyExpenses = expenses.filter(e => e.date === date);
        const totalTWD = dailyExpenses.reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);
        return totalTWD;
      };

      const openGoogleMaps = (e, content) => { e.stopPropagation(); window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content)}`, '_blank'); };
      const scrollToDay = (index) => { if (dayScrollRef.current) { const width = dayScrollRef.current.offsetWidth; dayScrollRef.current.scrollTo({ left: width * index, behavior: 'smooth' }); setCurrentDayIndex(index); }};

      const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > 800) { height = Math.round((height * 800) / width); width = 800; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }; img.src = event.target.result;
            }; reader.readAsDataURL(file);
        });
      };

      const handleIconUpload = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          try {
              const base64 = await compressImage(file);
              setAppIcon(base64);
              // Directly update DOM to reflect change immediately
              document.getElementById('app-icon').href = base64;
              document.getElementById('fav-icon').href = base64;
              alert('åœ–ç¤ºæ›´æ–°æˆåŠŸï¼è«‹å˜—è©¦å°‡ç¶²é åŠ å…¥ä¸»ç•«é¢æŸ¥çœ‹æ•ˆæœã€‚');
          } catch(err) {
              alert('åœ–ç¤ºä¸Šå‚³å¤±æ•—');
          }
      };

      const handleFileSelect = async (e) => {
        const file = e.target.files[0]; if (!file) return; setIsScanning(true);
        try {
            if (scanType === 'photo' && targetDayId) {
                const base64 = await compressImage(file);
                updateItinerary(targetDayId, 'photo', base64); alert('ç…§ç‰‡å·²å„²å­˜ï¼');
            } else if (scanType === 'memo' && activeMemoSection) { 
                const base64 = await compressImage(file);
                setNewMemo(prev => ({ ...prev, image: base64 }));
            } else {
                if (typeof Tesseract === 'undefined') { alert('è¾¨è­˜åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦'); return; }
                const { data: { text } } = await Tesseract.recognize(file, 'eng+jpn+chi_tra');
                if (scanType === 'receipt') {
                    const numbers = text.match(/\d{1,3}(,\d{3})*(\.\d+)?/g) || [];
                    const cleanNumbers = numbers.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => n > 100); 
                    const maxAmount = cleanNumbers.length > 0 ? Math.max(...cleanNumbers) : '';
                    let guessedCategory = 'ğŸœ é£²é£Ÿ';
                    const lowerText = text.toLowerCase();
                    if (lowerText.includes('uniqlo')) guessedCategory = 'ğŸ›ï¸ è³¼ç‰©';
                    else if (lowerText.includes('bus')) guessedCategory = 'ğŸšƒ äº¤é€š';
                    else if (lowerText.includes('hotel')) guessedCategory = 'ğŸ¨ ä½å®¿';
                    setNewExpense(prev => ({ ...prev, amount: maxAmount || prev.amount, category: guessedCategory, note: 'OCRè‡ªå‹•è¾¨è­˜' }));
                    alert(`æ”¶æ“šè¾¨è­˜å®Œæˆï¼é‡‘é¡: ${maxAmount}`);
                }
            }
        } catch (error) { console.error(error); alert('è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦'); } 
        finally { setIsScanning(false); if(fileInputRef.current) fileInputRef.current.value = ''; if(scanType !== 'memo') setScanType(null); setTargetDayId(null); }
      };

      const triggerFileAction = (type, id = null) => { setScanType(type); setTargetDayId(id); fileInputRef.current.click(); };

      const addDay = () => {
        const newId = Date.now(); let nextDate = new Date();
        if (itinerary.length > 0) { const lastDate = new Date(itinerary[itinerary.length - 1].date); lastDate.setDate(lastDate.getDate() + 1); nextDate = lastDate; } 
        else if (budgetSettings.startDate) { nextDate = new Date(budgetSettings.startDate); }
        const dateStr = nextDate.toISOString().split('T')[0];
        const newDay = { id: newId, date: dateStr, weekday: getWeekday(dateStr), content: '', transport: '', stay: '', food: '', highlights: '', photo: null, schedule: [] };
        setItinerary([...itinerary, newDay]); setTimeout(() => scrollToDay(itinerary.length), 100);
      };
      const removeDay = (id) => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©å—ï¼Ÿ')) setItinerary(itinerary.filter(d => d.id !== id)); };
      const updateItinerary = (id, field, value) => { setItinerary(itinerary.map(item => item.id === id ? { ...item, [field]: value } : item)); };

      const addScheduleItem = (dayId) => {
          const newScheduleItem = { id: Date.now(), time: '09:00', category: 'æ™¯é»', activity: '', note: '' };
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) { return { ...day, schedule: [...(day.schedule || []), newScheduleItem] }; }
              return day;
          }); setItinerary(updatedItinerary);
      };
      const updateScheduleItem = (dayId, itemId, field, value) => {
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) {
                  const updatedSchedule = day.schedule.map(item => item.id === itemId ? { ...item, [field]: value } : item);
                  return { ...day, schedule: updatedSchedule };
              } return day;
          }); setItinerary(updatedItinerary);
      };
      const removeScheduleItem = (dayId, itemId) => {
          if(!confirm('åˆªé™¤æ­¤è¡Œç¨‹ç¯€é»ï¼Ÿ')) return;
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) { return { ...day, schedule: day.schedule.filter(item => item.id !== itemId) }; }
              return day;
          }); setItinerary(updatedItinerary);
      };
      const handleScheduleLongPress = (id) => { setEditingScheduleId(id); };
      const moveScheduleItem = (dayId, itemId, direction) => {
          const dayIndex = itinerary.findIndex(d => d.id === dayId);
          if (dayIndex === -1) return;
          const day = itinerary[dayIndex];
          const itemIndex = day.schedule.findIndex(i => i.id === itemId);
          if (itemIndex === -1) return;
          const newSchedule = [...day.schedule];
          if (direction === 'up' && itemIndex > 0) { [newSchedule[itemIndex], newSchedule[itemIndex - 1]] = [newSchedule[itemIndex - 1], newSchedule[itemIndex]]; } 
          else if (direction === 'down' && itemIndex < newSchedule.length - 1) { [newSchedule[itemIndex], newSchedule[itemIndex + 1]] = [newSchedule[itemIndex + 1], newSchedule[itemIndex]]; }
          const newItinerary = [...itinerary]; newItinerary[dayIndex] = { ...day, schedule: newSchedule }; setItinerary(newItinerary);
      };

      const handleDirectAddExpense = () => {
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]);
        setNewExpense({ ...newExpense, item: '', amount: '' }); 
      };

      const handleAddExpense = () => { 
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]);
        
        // V38: Handle Shopping Checkout Logic (auto check item)
        if (pendingShopItemId) {
            setShoppingList(shoppingList.map(item => item.id === pendingShopItemId ? { ...item, bought: true } : item));
            setPendingShopItemId(null);
        }

        setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
        setShowExpenseModal(false);
      };

      const handleScheduleToExpense = (dayDate, scheduleItem) => {
          let expenseCategory = 'ğŸ“ å…¶ä»–';
          switch(scheduleItem.category) {
              case 'åƒé£¯': expenseCategory = 'ğŸœ é£²é£Ÿ'; break;
              case 'äº¤é€š': expenseCategory = 'ğŸšƒ äº¤é€š'; break;
              case 'ä½å®¿': expenseCategory = 'ğŸ¨ ä½å®¿'; break;
              case 'é€›è¡—': expenseCategory = 'ğŸ›ï¸ è³¼ç‰©'; break;
              case 'æ™¯é»': expenseCategory = 'ğŸ« é–€ç¥¨'; break;
              default: expenseCategory = 'ğŸ“ å…¶ä»–';
          }
          setNewExpense({ ...newExpense, date: dayDate, item: scheduleItem.activity, category: expenseCategory, amount: '', note: scheduleItem.note, currency: 'JPY' });
          setShowExpenseModal(true);
      };

      const handleShopToExpense = (e, item) => {
          e.stopPropagation(); 
          setPendingShopItemId(item.id);
          const today = new Date().toISOString().split('T')[0];
          setNewExpense({
              ...newExpense,
              date: today, 
              item: item.item,
              category: 'ğŸ›ï¸ è³¼ç‰©',
              amount: item.budget, 
              currency: item.currency || 'JPY',
              note: item.note || ''
          });
          setShowExpenseModal(true);
      };

      const handleDeleteExpense = (id) => { if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) setExpenses(expenses.filter(e => e.id !== id)); };

      const handleAddShoppingItem = () => {
        if (!newShopItem.item) return;
        setShoppingList([...shoppingList, { id: Date.now(), ...newShopItem, budget: parseFloat(newShopItem.budget) || 0, splitCount: parseInt(newShopItem.splitCount) || 1, bought: false }]);
        setNewShopItem({ item: '', budget: '', currency: 'JPY', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });
      };
      const toggleShoppingItem = (id) => setShoppingList(shoppingList.map(item => item.id === id ? { ...item, bought: !item.bought } : item));
      const deleteShoppingItem = (id) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setShoppingList(shoppingList.filter(i => i.id !== id)); };

      const togglePackingItem = (id) => setPackingList(packingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      const addPackingItemToCategory = (category) => {
          if(!newPackingItemText) return;
          setPackingList([...packingList, { id: Date.now(), category: category, item: newPackingItemText, checked: false }]);
          setNewPackingItemText(''); setActivePackingCategory(null);
      };
      const deletePackingItem = (id) => setPackingList(packingList.filter(i => i.id !== id));
      const addPackingCategory = () => { if(newCategoryName && !packingCategories.includes(newCategoryName)) { setPackingCategories([...packingCategories, newCategoryName]); setNewCategoryName(''); }};
      const deletePackingCategory = (category) => { if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${category}ã€ï¼Ÿ`)) { setPackingCategories(packingCategories.filter(c => c !== category)); setPackingList(packingList.filter(item => item.category !== category)); }};

      const addBookingPlatform = () => { if (newPlatformName && !bookingPlatforms.includes(newPlatformName)) { setBookingPlatforms([...bookingPlatforms, newPlatformName]); setNewPlatformName(''); } };
      const deleteBookingPlatform = (p) => { if(confirm(`ç¢ºå®šåˆªé™¤å¹³å°ã€Œ${p}ã€ï¼Ÿ`)) setBookingPlatforms(bookingPlatforms.filter(item => item !== p)); };

      const handleBatchImport = () => {
          if (!batchText) return;
          const items = batchText.split('\n').filter(line => line.trim() !== '');
          if (batchType === 'shopping') {
              const newItems = items.map(line => ({ id: Date.now() + Math.random(), item: line.trim(), budget: 0, currency: 'JPY', store: '', priority: 'medium', type: 'self', note: '', splitCount: 1, bought: false }));
              setShoppingList([...shoppingList, ...newItems]);
          } else if (batchType === 'packing') {
              const newItems = items.map(line => ({ id: Date.now() + Math.random(), category: 'ğŸ“ è‡ªè¨‚', item: line.trim(), checked: false }));
              setPackingList([...packingList, ...newItems]);
          }
          setBatchText(''); setShowBatchModal(false); alert(`å·²åŒ¯å…¥ ${items.length} å€‹é …ç›®ï¼`);
      };

      const handleAddMemo = (sectionId) => {
          if (!newMemo.title && sectionId === 'flight') return; 
          if (!newMemo.title && sectionId === 'hotel') return; 

          setMemos([...memos, { 
              id: Date.now(), 
              date: newMemo.date, 
              category: sectionId, 
              title: newMemo.title,
              content: newMemo.content,
              bookingRef: newMemo.bookingRef,
              seat: newMemo.seat,
              address: newMemo.address,
              image: newMemo.image
          }]);
          
          setNewMemo({ date: '2026-02-02', category: '', title: '', content: '', bookingRef: '', seat: '', address: '', image: null });
          setActiveMemoSection(null);
      };
      const deleteMemo = (id) => { if(confirm('ç¢ºå®šåˆªé™¤é€™æ¢å‚™å¿˜ï¼Ÿ')) setMemos(memos.filter(m => m.id !== id)); };

      const fetchExchangeRate = async () => {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
            if (!res.ok) throw new Error('Network response was not ok');
            const data = await res.json();
            
            if(data && data.rates) {
                const newRates = { ...budgetSettings.rates };
                let updatedCount = 0;
                CURRENCIES.forEach(c => {
                    if (c.code === 'TWD') return;
                    const rateInTwdBase = data.rates[c.code];
                    if (rateInTwdBase) {
                        const foreignToTwd = 1 / rateInTwdBase;
                        newRates[`${c.code}_TWD`] = parseFloat(foreignToTwd.toFixed(4));
                        updatedCount++;
                    }
                });
                setBudgetSettings({ ...budgetSettings, rates: newRates });
                alert(`âœ… æˆåŠŸæ›´æ–° ${updatedCount} ç¨®è²¨å¹£åŒ¯ç‡ï¼\n(åŸºæº–: 1 TWD)`);
            }
        } catch(e) { 
            console.error(e);
            alert('âš ï¸ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\nç›®å‰åƒ…èƒ½æ‰‹å‹•è¼¸å…¥åŒ¯ç‡ã€‚'); 
        }
      };

      const addMethod = (m) => { if(m && !paymentMethods.includes(m)) setPaymentMethods([...paymentMethods, m]); };
      const removeMethod = (m) => setPaymentMethods(paymentMethods.filter(i => i !== m));

      const totalSpentConvertedTWD = expenses.reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);
      const remainingBudget = budgetSettings.totalTWD - totalSpentConvertedTWD;

      const shoppingStats = shoppingList.reduce((acc, item) => {
        const itemTWD = Math.round(item.budget * getExchangeRate(item.currency || 'JPY'));
        if (item.type === 'agent') { acc.agentCount++; acc.agentTotal += itemTWD; }
        else if (item.type === 'split') { acc.splitCount++; acc.splitTotal += itemTWD; }
        else { acc.selfCount++; acc.selfTotal += itemTWD; }
        return acc;
      }, { agentTotal: 0, agentCount: 0, selfTotal: 0, selfCount: 0, splitTotal: 0, splitCount: 0 });

      // Agent Summary Logic
      const agentSummary = shoppingList
        .filter(item => item.type === 'agent' && item.note)
        .reduce((acc, item) => {
            const name = item.note.trim();
            if (!acc[name]) acc[name] = { totalTWD: 0 };
            acc[name].totalTWD += Math.round(item.budget * getExchangeRate(item.currency || 'JPY'));
            return acc;
        }, {});

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        const itineraryData = [];
        itinerary.forEach(d => {
            if (d.schedule && d.schedule.length > 0) { d.schedule.forEach(s => itineraryData.push({ 'æ—¥æœŸ': d.date, 'æ˜ŸæœŸ': d.weekday, 'æ™‚é–“': s.time, 'é¡åˆ¥': s.category, 'è¡Œç¨‹': s.activity, 'å‚™è¨»': s.note })); } 
            else { itineraryData.push({ 'æ—¥æœŸ': d.date, 'æ˜ŸæœŸ': d.weekday, 'æ™‚é–“': '', 'é¡åˆ¥': 'å…¨æ—¥', 'è¡Œç¨‹': d.content || 'æœªè¦åŠƒ', 'å‚™è¨»': '' }); }
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shoppingList.map(s => ({ 'é¡åˆ¥': s.priority, 'é …ç›®': s.item, 'é ç®—': s.budget, 'å¹£åˆ¥': s.currency }))), 'æˆ°åˆ©å“');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses.map(e => ({ 'æ—¥æœŸ': e.date, 'é …ç›®': e.item, 'é‡‘é¡': e.amount, 'å¹£åˆ¥': e.currency }))), 'è¨˜å¸³');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(itineraryData), 'è¡Œç¨‹æ‰‹å†Š');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(packingList.map(p => ({ 'é …ç›®': p.item, 'å·²å¸¶': p.checked ? 'V' : '' }))), 'è¡Œæ');
        XLSX.writeFile(wb, `Reginaç’°çƒèµ°è·³_å®Œæ•´å ±è¡¨.xlsx`);
        setShowSettingsModal(false);
      };

      // --- New Component: Travel Booklet ---
      const TravelBooklet = () => {
          return (
              <div id="printable-booklet" className="bg-white text-black font-sans leading-relaxed">
                  <div className="no-print fixed top-4 right-4 flex gap-2 z-50">
                      <button onClick={() => window.print()} className="bg-[#5C6BC0] text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-[#3949AB] flex items-center gap-2"><Icons.Printer size={20}/> åˆ—å° / å­˜æˆ PDF</button>
                      <button onClick={() => setShowBooklet(false)} className="bg-gray-500 text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-gray-600">é—œé–‰</button>
                  </div>
                  
                  {/* Cover Page */}
                  <div className="min-h-screen flex flex-col items-center justify-center border-b-2 border-gray-100 p-10 page-break">
                      <div className="text-[100px]">ğŸŒ</div>
                      <h1 className="text-5xl font-black text-[#FF6B6B] mb-4 text-center tracking-widest">Regina ç’°çƒèµ°è·³</h1>
                      <div className="text-2xl font-bold text-gray-500 mb-10">{formatDate(itinerary[0]?.date)} - {formatDate(itinerary[itinerary.length-1]?.date)}</div>
                      <div className="border-4 border-dashed border-gray-300 p-8 rounded-3xl w-full max-w-md bg-[#FFF8E1]">
                          <div className="text-center text-xl font-bold text-[#F57C00] mb-4">âœ¨ æ—…éŠå°æ›¸ âœ¨</div>
                          <div className="space-y-2 text-gray-600 font-bold text-lg text-center">
                              <div>å¸¶è‘—å¥½å¿ƒæƒ…å‡ºç™¼ï¼</div>
                              <div>è­·ç…§ã€éŒ¢åŒ…ã€æ‰‹æ©Ÿå¸¶äº†å—ï¼Ÿ</div>
                              <div>Are you ready?</div>
                          </div>
                      </div>
                  </div>

                  {/* Info Page */}
                  <div className="min-h-screen p-10 page-break">
                      <h2 className="text-3xl font-black text-[#3949AB] mb-6 flex items-center gap-2 border-b-4 border-[#C5CAE9] pb-2"><Icons.Info size={32}/> é‡è¦è³‡è¨Š</h2>
                      
                      {/* Booklet Info Layout */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {MEMO_SECTIONS.map(section => {
                              const sectionMemos = memos.filter(m => m.category === section.id).sort((a,b)=>new Date(a.date)-new Date(b.date));
                              if (sectionMemos.length === 0) return null;
                              return (
                                  <div key={section.id} className={`border-2 ${section.color} rounded-xl p-4 break-inside-avoid`}>
                                      <h3 className={`font-bold text-xl mb-3 flex items-center gap-2 ${section.text}`}>{section.icon} {section.label}</h3>
                                      <div className="space-y-3">
                                          {sectionMemos.map(memo => (
                                              <div key={memo.id} className="bg-gray-50 p-2 rounded-lg relative">
                                                  <div className="text-sm font-bold text-gray-400 mb-1">{formatDate(memo.date)} ({getWeekday(memo.date)})</div>
                                                  <div className="font-bold text-gray-800 text-lg">{memo.title || (section.id === 'note' ? 'ç­†è¨˜' : '')}</div>
                                                  
                                                  {section.id === 'flight' && (
                                                      <div className="mt-1 text-sm text-gray-600 flex gap-2">
                                                          {memo.bookingRef && <span className="bg-blue-100 px-2 rounded">Ref: {memo.bookingRef}</span>}
                                                          {memo.seat && <span className="bg-green-100 px-2 rounded">Seat: {memo.seat}</span>}
                                                      </div>
                                                  )}
                                                  {section.id === 'hotel' && (
                                                      <div className="mt-1 text-sm text-gray-600">
                                                          {memo.address && <div className="text-gray-500 mb-1">{memo.address}</div>}
                                                          {memo.bookingRef && <span className="bg-purple-100 px-2 rounded">è¨‚å–®: {memo.bookingRef}</span>}
                                                      </div>
                                                  )}
                                                  {section.id === 'food' && memo.address && (
                                                      <div className="text-xs text-gray-500 mb-1">{memo.address}</div>
                                                  )}

                                                  {memo.content && <div className="text-xs text-gray-500 mt-1 whitespace-pre-wrap">{memo.content}</div>}
                                                  
                                                  {memo.image && <img src={memo.image} className="mt-2 w-24 h-24 object-cover rounded-lg border border-gray-300" />}
                                              </div>
                                          ))}
                                      </div>
                                  </div>
                              )
                          })}
                      </div>
                  </div>

                  {/* Daily Pages */}
                  {itinerary.map(day => (
                      <div key={day.id} className="min-h-screen p-8 page-break bg-white">
                          <div className="flex justify-between items-end border-b-4 border-gray-800 pb-2 mb-6">
                              <h2 className="text-4xl font-black text-gray-800">{formatDate(day.date)} <span className="text-2xl text-gray-500">({day.weekday})</span></h2>
                              <div className="text-right text-gray-400 font-bold text-sm">Day {itinerary.findIndex(d => d.id === day.id) + 1}</div>
                          </div>
                          
                          {/* Daily Summary Box */}
                          <div className="flex gap-4 mb-6">
                             <div className="flex-1 border-2 border-gray-200 rounded-xl p-3 bg-gray-50">
                                 <div className="text-xs text-gray-500 font-bold mb-1 flex items-center gap-1"><Icons.Train size={14}/> äº¤é€š</div>
                                 <div className="font-bold text-lg">{day.transport || 'æœªå¡«å¯«'}</div>
                             </div>
                             <div className="flex-1 border-2 border-gray-200 rounded-xl p-3 bg-gray-50">
                                 <div className="text-xs text-gray-500 font-bold mb-1 flex items-center gap-1"><Icons.Home size={14}/> ä½å®¿</div>
                                 <div className="font-bold text-lg">{day.stay || 'æœªå¡«å¯«'}</div>
                             </div>
                          </div>

                          {/* Timeline */}
                          <div className="space-y-4">
                              {day.schedule && day.schedule.length > 0 ? day.schedule.sort((a,b)=>a.time.localeCompare(b.time)).map(item => (
                                  <div key={item.id} className="flex gap-4 items-start group break-inside-avoid">
                                      <div className="w-16 pt-2 text-right font-black text-xl text-gray-400 shrink-0">{item.time}</div>
                                      <div className="relative flex-1 bg-white border-2 border-gray-200 rounded-2xl p-4 shadow-sm print-shadow-none print-border-black">
                                          {/* Dot */}
                                          <div className="absolute top-5 -left-[25px] w-4 h-4 bg-gray-300 rounded-full border-2 border-white"></div>
                                          <div className="flex justify-between items-start mb-1">
                                              <span className="text-2xl font-black text-gray-800">{item.activity}</span>
                                              <span className="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600">{item.category}</span>
                                          </div>
                                          {item.note && <div className="text-gray-500 font-bold mt-1 text-sm border-t border-dashed border-gray-200 pt-2">{item.note}</div>}
                                      </div>
                                  </div>
                              )) : <div className="text-center text-gray-400 py-10 font-bold">æœ¬æ—¥å°šç„¡è©³ç´°è¡Œç¨‹</div>}
                          </div>
                          
                          {/* Note Area */}
                          <div className="mt-8 border-4 border-dashed border-gray-200 rounded-xl p-4 min-h-[150px] break-inside-avoid">
                              <div className="text-gray-300 font-bold text-center">ç­†è¨˜ / ç´€å¿µç« </div>
                          </div>
                      </div>
                  ))}

                  {/* Packing List */}
                  <div className="min-h-screen p-10 page-break">
                      <h2 className="text-3xl font-black text-[#BA68C8] mb-6 flex items-center gap-2 border-b-4 border-[#E1BEE7] pb-2"><Icons.Suitcase size={32}/> è¡Œææª¢æŸ¥è¡¨</h2>
                      <div className="columns-2 gap-6">
                          {packingCategories.map(cat => {
                              const items = packingList.filter(i => i.category === cat);
                              if (items.length === 0) return null;
                              return (
                                  <div key={cat} className="break-inside-avoid mb-6 border-2 border-gray-200 rounded-xl p-4">
                                      <h3 className="font-bold text-lg mb-3 bg-gray-100 px-2 py-1 rounded">{cat}</h3>
                                      <div className="space-y-2">
                                          {items.map(item => (
                                              <div key={item.id} className="flex items-center gap-2">
                                                  <div className="w-5 h-5 border-2 border-gray-400 rounded"></div>
                                                  <span className="font-bold text-gray-700">{item.item}</span>
                                              </div>
                                          ))}
                                      </div>
                                  </div>
                              )
                          })}
                      </div>
                  </div>
              </div>
          );
      };

      const ExpenseModal = () => (
         <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExpenseModal(false)}>
            <div className="bg-white w-11/12 max-w-sm rounded-3xl p-5 fade-in" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">ğŸ’° è¨˜ä¸€ç­† ({newExpense.date})</h3>
                <div className="space-y-3">
                   <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="w-full bg-gray-100 rounded-xl p-3 outline-none font-bold">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                   <input placeholder="è²·äº†ä»€éº¼ï¼Ÿ" value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="w-full text-lg font-bold border-b-2 border-dashed border-gray-300 outline-none py-1" />
                   <div className="flex gap-2">
                       <input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="flex-1 bg-gray-100 rounded-xl p-3 font-bold text-xl outline-none" autoFocus />
                       <select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})} className="bg-gray-100 rounded-xl p-1 font-bold text-lg">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.flag} {c.code}</option>)}</select>
                   </div>
                   <button onClick={handleAddExpense} className="w-full bg-[#FF9F43] text-white font-bold py-3 rounded-xl korean-3d-btn">ç¢ºå®šè¨˜å¸³</button>
                </div>
            </div>
         </div>
      );

      const SettingsModal = () => {
        const [tempMethod, setTempMethod] = useState('');
        const [tempPlatform, setTempPlatform] = useState('');
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowSettingsModal(false)}>
              <div className="bg-white w-11/12 max-w-md rounded-3xl p-6 fade-in shadow-2xl h-4/5 flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 className="font-bold text-2xl text-gray-800">âš™ï¸ è¨­å®š</h3>
                    <button onClick={() => setShowSettingsModal(false)}><Icons.X size={30}/></button>
                </div>
                
                <input type="file" accept="image/*" ref={iconInputRef} onChange={handleIconUpload} className="hidden" />
                <div className="bg-gray-50 p-4 rounded-xl mb-4 border-2 border-gray-200">
                    <h4 className="font-bold text-lg text-gray-600 mb-2 flex items-center gap-2">ğŸ“± æ‰‹æ©Ÿæ¡Œé¢åœ–ç¤º</h4>
                    <div className="flex items-center gap-4">
                         <div className="w-16 h-16 rounded-2xl bg-gray-200 overflow-hidden shadow-sm border border-gray-300">
                            {appIcon ? <img src={appIcon} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-2xl">ğŸ¦€</div>}
                         </div>
                         <button onClick={() => iconInputRef.current.click()} className="bg-[#5C6BC0] text-white px-4 py-2 rounded-xl font-bold shadow-md hover:bg-[#3949AB] flex items-center gap-2"><Icons.Upload size={20}/> ä¸Šå‚³ç…§ç‰‡</button>
                    </div>
                    <div className="text-xs text-gray-400 mt-2 font-bold">ä¸Šå‚³å¾Œè«‹ä½¿ç”¨ç€è¦½å™¨ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½</div>
                </div>
                
                <div className="flex gap-2 mb-4">
                     <button onClick={exportToExcel} className="flex-1 bg-[#2E7D32] text-white font-bold text-sm py-3 rounded-xl shadow-md flex items-center justify-center gap-1 hover:bg-[#1B5E20] transition-colors"><Icons.FileSpreadsheet size={20}/> åŒ¯å‡º Excel</button>
                     <button onClick={() => { setShowSettingsModal(false); setShowBooklet(true); }} className="flex-1 bg-[#5C6BC0] text-white font-bold text-sm py-3 rounded-xl shadow-md flex items-center justify-center gap-1 hover:bg-[#3949AB] transition-colors"><Icons.BookOpen size={20}/> è£½ä½œæ—…éŠå°æ›¸</button>
                </div>

                <div className="flex-1 overflow-y-auto space-y-6 no-scrollbar pb-10">
                    <div className="bg-[#E0F2F1] p-4 rounded-xl border-2 border-[#80CBC4]">
                        <h4 className="font-bold text-xl text-[#00695C] mb-3 flex items-center gap-2"><Icons.Calendar/> æ—…éŠæ—¥æœŸ</h4>
                        <div><label className="text-sm text-gray-600 font-bold ml-1">æ—…éŠé–‹å§‹æ—¥æœŸ</label><div className="flex gap-2"><input type="date" value={budgetSettings.startDate} onChange={e => setBudgetSettings({...budgetSettings, startDate: e.target.value})} className="w-full p-2 rounded-lg border-2 border-[#80CBC4] outline-none font-bold text-xl text-gray-800"/><button onClick={updateItineraryDates} className="bg-[#26A69A] text-white px-3 py-1 rounded-lg font-bold text-sm shrink-0">æ›´æ–°æ—¥æœŸ</button></div></div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å·¥å…· (å¢/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full"><input value={tempMethod} onChange={e => setTempMethod(e.target.value)} placeholder="æ–°å¢..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" /><button onClick={() => { addMethod(tempMethod); setTempMethod(''); }} className="bg-gray-800 text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button></div>
                        <div className="flex flex-wrap gap-2">{paymentMethods.map(m => (<div key={m} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{m} <button onClick={() => removeMethod(m)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å¹³å° (å¢/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full"><input value={tempPlatform} onChange={e => setTempPlatform(e.target.value)} placeholder="æ–°å¢å¹³å°..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" /><button onClick={() => { addPlatform(tempPlatform); setTempPlatform(''); }} className="bg-[#4ECDC4] text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button></div>
                        <div className="flex flex-wrap gap-2">{bookingPlatforms.map(p => (<div key={p} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{p} <button onClick={() => removePlatform(p)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div className="bg-[#FFF3E0] p-4 rounded-xl border-2 border-[#FFE0B2]">
                        <h4 className="font-bold text-xl text-[#F57C00] mb-3 flex items-center gap-2"><Icons.Coins/> åŒ¯ç‡è¨­å®š (å°å°å¹£)</h4>
                        <div className="space-y-3">
                            <div><label className="text-sm text-gray-600 font-bold ml-1">å°å¹£ç¸½é ç®—</label><div className="flex items-center bg-white rounded-lg px-2 border-2 border-[#FFE0B2]"><span className="text-gray-400 font-bold text-xl">$</span><input type="number" value={budgetSettings.totalTWD} onChange={e => setBudgetSettings({...budgetSettings, totalTWD: parseInt(e.target.value)||0})} className="w-full p-2 outline-none font-bold text-2xl text-gray-800"/></div></div>
                            
                            <button onClick={fetchExchangeRate} className="w-full bg-[#FF9F43] text-white px-4 py-3 rounded-xl font-bold shadow-md hover:bg-[#F57C00] transition-colors flex items-center justify-center gap-2"><Icons.Globe size={20}/> ğŸŒ é€£ç·šæ›´æ–°åŒ¯ç‡ (ä»¥TWDç‚ºåŸºæº–)</button>

                            {/* Dynamic Currency Rates with Flags */}
                            <div className="grid grid-cols-2 gap-3 mt-2 max-h-60 overflow-y-auto no-scrollbar">
                                {CURRENCIES.filter(c => c.code !== 'TWD').map(c => (
                                    <div key={c.code}>
                                        <label className="text-xs text-gray-500 font-bold flex items-center gap-1">{c.flag} {c.name} ({c.code})</label>
                                        <input type="number" step="0.0001" 
                                            value={budgetSettings.rates[`${c.code}_TWD`] || c.defaultRate} 
                                            onChange={e => setBudgetSettings({...budgetSettings, rates: {...budgetSettings.rates, [`${c.code}_TWD`]: parseFloat(e.target.value)||0}})} 
                                            className="w-full p-2 rounded-lg border-2 border-[#FFE0B2] outline-none font-bold text-lg text-gray-800"/>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        );
      };

      const BatchModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowBatchModal(false)}>
            <div className="bg-white w-11/12 max-w-sm rounded-2xl p-5 fade-in" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">ğŸ“‹ æ‰¹æ¬¡åŒ¯å…¥ {batchType === 'shopping' ? 'æˆ°åˆ©å“' : 'è¡Œæ'}</h3>
                <textarea className="w-full h-40 bg-gray-50 border-2 border-gray-200 rounded-xl p-3 outline-none font-bold text-gray-700" placeholder="è²¼ä¸Šæ¸…å–®ï¼Œä¸€è¡Œä¸€é …..." value={batchText} onChange={e => setBatchText(e.target.value)}></textarea>
                <div className="flex gap-2 mt-4">
                    <button onClick={() => setShowBatchModal(false)} className="flex-1 py-3 text-gray-400 font-bold">å–æ¶ˆ</button>
                    <button onClick={handleBatchImport} className="flex-1 bg-[#4ECDC4] text-white py-3 rounded-xl font-bold korean-3d-btn">é–‹å§‹åŒ¯å…¥</button>
                </div>
            </div>
        </div>
      );

      const FloatingActionButton = () => (
          <button onClick={() => activeTab === 'itinerary' && currentDayIndex !== null ? addScheduleItem(itinerary[currentDayIndex]?.id) : addDay()} className="fixed bottom-24 right-6 z-40 w-14 h-14 bg-[#FF6B6B] text-white rounded-full shadow-lg flex items-center justify-center border-2 border-white hover:scale-110 active:scale-95 transition-transform"><Icons.Plus size={32} /></button>
      );

      const TabButton = ({ id, IconComp, label, bgColor, activeColor }) => (
        <button onClick={() => { setActiveTab(id); }} className={`flex flex-col items-center justify-center rounded-2xl py-1 transition-all duration-150 w-full h-full relative overflow-hidden group ${activeTab === id ? 'translate-y-1 shadow-none ring-2 ring-offset-1' : 'shadow-[0_4px_0_0_rgba(0,0,0,0.2)] hover:-translate-y-0.5 hover:shadow-[0_5px_0_0_rgba(0,0,0,0.2)]'}`} style={{ backgroundColor: activeTab === id ? activeColor : bgColor, color: activeTab === id ? '#fff' : '#555', borderColor: activeTab === id ? activeColor : 'transparent' }}>
          <IconComp size={24} className="mb-0.5 drop-shadow-sm z-10" />
          <span className="text-[10px] sm:text-xs font-black z-10 drop-shadow-sm tracking-wide">{label}</span>
          {activeTab === id && <div className="absolute inset-0 bg-black/10 z-0"></div>}
        </button>
      );

      return (
        <div className="flex flex-col h-full bg-white w-full max-w-4xl mx-auto shadow-2xl overflow-hidden relative font-sans text-gray-900">
          
          {showBooklet && <TravelBooklet />}

          {isScanning && <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 text-white"><Icons.Loader size={60} className="loading-spin mb-4 text-[#FF6B6B]" /><div className="text-3xl font-bold animate-pulse">è™•ç†ä¸­...</div></div>}
          <input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
          {showSettingsModal && <SettingsModal />}
          {showExpenseModal && <ExpenseModal />}
          {showExportModal && <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExportModal(false)}><div className="bg-white w-11/12 max-w-sm rounded-2xl p-6 fade-in" onClick={e => e.stopPropagation()}><h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">ğŸ“Š åŒ¯å‡º Excel</h3><button onClick={exportToExcel} className="w-full bg-[#207245] text-white font-bold text-xl py-4 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2 mb-2"><Icons.FileSpreadsheet size={24} /> ä¸‹è¼‰å ±è¡¨</button><button onClick={() => setShowExportModal(false)} className="w-full text-gray-500 font-bold py-3 text-lg">å–æ¶ˆ</button></div></div>}
          {showBatchModal && <BatchModal />}

          <div className="safe-area-top"></div>

          {/* Header */}
          <div className="bg-[#FF6B6B] px-4 py-2 relative overflow-hidden border-b-2 border-black shrink-0 z-50">
            <div className="flex justify-between items-center">
              <h1 className="text-2xl font-bold text-white tracking-widest flex items-center gap-2"><span>ğŸŒ</span> Regina ç’°çƒèµ°è·³ ğŸ‘£</h1>
              <div className="flex items-center gap-3">
                  <WeatherWidget />
                  <button onClick={() => setShowSettingsModal(true)} className="text-white hover:text-gray-100 bg-white/20 p-1.5 rounded-full"><Icons.Settings size={24} /></button>
              </div>
            </div>
          </div>

          <div className="flex-1 overflow-hidden relative bg-[#E0F7FA]">
            {activeTab === 'itinerary' && (
              <div className="h-full flex flex-col p-4">
                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-3 shrink-0 py-1">
                  {itinerary.map((day, index) => (<button key={day.id} onClick={() => scrollToDay(index)} className={`shrink-0 w-12 h-12 rounded-full font-bold text-lg border-4 border-white shadow-md flex items-center justify-center transition-all ${currentDayIndex === index ? 'scale-110 ring-2 ring-black' : 'opacity-70'}`} style={{ backgroundColor: BUTTON_COLORS[index % BUTTON_COLORS.length], color: 'white' }}>{formatDate(day.date)}</button>))}
                  <button onClick={addDay} className="shrink-0 w-12 h-12 rounded-full bg-white border-4 border-dashed border-gray-400 flex items-center justify-center text-gray-400 hover:text-[#FF6B6B]"><Icons.Plus size={24}/></button>
                </div>
                <div ref={dayScrollRef} className="flex-1 flex overflow-x-auto snap-x-mandatory no-scrollbar gap-4 h-full" onScroll={(e) => { const index = Math.round(e.target.scrollLeft / e.target.offsetWidth); setCurrentDayIndex(index); }}>
                    {itinerary.map((day, index) => {
                        const dayTotal = getDailyTotal(day.date);
                        return (
                            <div key={day.id} className="w-full shrink-0 snap-center flex flex-col h-full">
                                <div className="bg-white border-4 border-black rounded-3xl shadow-xl flex flex-col relative h-full overflow-hidden">
                                    <div className="bg-gray-50 border-b-2 border-dashed border-gray-300 p-3 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-2"><span className="font-black text-3xl text-gray-800">{formatDate(day.date)}</span><span className="text-xl font-bold text-gray-400">({getWeekday(day.date)})</span></div>
                                        <div className="flex gap-2"><button onClick={() => triggerFileAction('itinerary', day.id)} className="p-2 bg-[#E1BEE7] text-[#9C27B0] rounded-xl border border-black shadow active:translate-y-1"><Icons.Camera size={18}/></button><button onClick={() => removeDay(day.id)} className="p-2 bg-gray-100 text-gray-500 rounded-xl border border-gray-300 hover:text-red-500"><Icons.Trash2 size={18}/></button></div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 paper-texture">
                                        <div className="bg-white/90 rounded-2xl p-3 border-2 border-gray-100 shadow-sm">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#0097A7] font-bold text-lg"><Icons.Clock size={24}/> è©³ç´°è¡Œç¨‹</div><button onClick={() => addScheduleItem(day.id)} className="text-[#0097A7] bg-[#E0F7FA] px-2 py-1 rounded-lg text-sm font-bold border border-[#B2EBF2]">+ æ–°å¢</button></div>
                                            <div className="space-y-2">{day.schedule && day.schedule.map(item => (<div key={item.id} className={`flex gap-2 items-start bg-gray-50 p-2 rounded-xl border border-gray-200 transition-all ${editingScheduleId === item.id ? 'scale-105 shadow-lg border-[#FF6B6B] bg-red-50 z-10' : ''}`} onTouchStart={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} onTouchEnd={() => clearTimeout(item.timer)} onMouseDown={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} onMouseUp={() => clearTimeout(item.timer)}><div className="flex flex-col gap-1 items-center"><input value={item.time} onChange={(e) => updateScheduleItem(day.id, item.id, 'time', e.target.value)} className="w-16 bg-white border border-gray-300 rounded-lg p-1 text-sm font-bold text-center outline-none" type="time" />{editingScheduleId === item.id && (<div className="flex flex-col gap-1"><button onClick={() => moveScheduleItem(day.id, item.id, 'up')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowUp size={12}/></button><button onClick={() => moveScheduleItem(day.id, item.id, 'down')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowDown size={12}/></button><button onClick={() => setEditingScheduleId(null)} className="text-[10px] text-blue-500 font-bold">å®Œæˆ</button></div>)}</div><div className="flex-1 space-y-1"><div className="flex gap-1"><select value={item.category} onChange={(e) => updateScheduleItem(day.id, item.id, 'category', e.target.value)} className="bg-white border border-gray-300 rounded-lg p-1 text-xs font-bold w-20 outline-none">{SCHEDULE_CATEGORIES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}</select><input value={item.activity} onChange={(e) => updateScheduleItem(day.id, item.id, 'activity', e.target.value)} className="flex-1 bg-transparent border-b border-dashed border-gray-300 outline-none text-base font-bold text-gray-800" placeholder="åšä»€éº¼..." /></div><input value={item.note} onChange={(e) => updateScheduleItem(day.id, item.id, 'note', e.target.value)} className="w-full bg-transparent outline-none text-xs text-gray-500" placeholder="å‚™è¨»..." /></div><div className="flex flex-col gap-2"><button onClick={() => handleScheduleToExpense(day.date, item)} className="text-white bg-[#FF9F43] p-1.5 rounded-lg hover:bg-[#FFB74D] shadow-sm"><Icons.Coins size={16}/></button><button onClick={() => removeScheduleItem(day.id, item.id)} className="text-gray-300 hover:text-red-400 p-1"><Icons.Trash2 size={16}/></button></div></div>))}</div>
                                        </div>
                                        <div className="flex gap-3"><div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#455A64] font-bold text-sm mb-1"><Icons.Train size={18}/> äº¤é€š</div><input value={day.transport} onChange={(e) => updateItinerary(day.id, 'transport', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="æ­è»Š..." /></div><div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#5C6BC0] font-bold text-sm mb-1"><Icons.Home size={18}/> ä½å®¿</div><input value={day.stay} onChange={(e) => updateItinerary(day.id, 'stay', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="é£¯åº—..." /></div></div>
                                        <div className="bg-[#FFF8E1] rounded-2xl p-3 border-2 border-[#FFE0B2] shadow-sm">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#F57C00] font-bold text-lg"><Icons.Coins size={22}/> æœ¬æ—¥å¸³æœ¬</div><span className="text-sm font-black text-[#F57C00]">${dayTotal.toLocaleString()}</span></div>
                                            <div className="space-y-1 mb-2">{expenses.filter(e => e.date === day.date).map(e => (<div key={e.id} className="flex justify-between text-xs text-gray-600 border-b border-dashed border-gray-300 pb-1"><span>{e.item}</span><span className="font-bold">{CURRENCIES.find(c => c.code === e.currency)?.flag} {CURRENCIES.find(c => c.code === e.currency)?.symbol}{e.amount}</span></div>))}</div>
                                            <button onClick={() => { setNewExpense({...newExpense, date: day.date}); setShowExpenseModal(true); }} className="w-full bg-[#FF9F43] text-white py-2 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition-transform">+ è¨˜ä¸€ç­†</button>
                                        </div>
                                        <div className="pt-1"><div className="flex items-center gap-2 text-gray-500 font-bold text-sm mb-2"><Icons.Camera size={18}/> æ‰“å¡ / ç…§ç‰‡æ—¥è¨˜</div><div onClick={() => triggerFileAction('photo', day.id)} className="w-full h-40 rounded-2xl border-4 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-white/50 overflow-hidden relative bg-white/30 group transition-all">{day.photo ? <img src={day.photo} alt="Daily" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-gray-400 group-hover:text-[#FF6B6B] transition-colors"><Icons.Image size={32}/><span className="text-xs font-bold mt-1">é»æ“Šä¸Šå‚³</span></div>}</div></div>
                                    </div>
                                    <div className="p-3 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center shrink-0"><button onClick={(e) => openGoogleMaps(e, day.content)} className="w-full bg-[#E0F7FA] text-[#00BCD4] px-4 py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-1 hover:bg-[#B2EBF2] border border-[#B2EBF2]"><Icons.Navigation size={16}/> Google Maps å°èˆª</button></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
                <FloatingActionButton />
              </div>
            )}

            {/* Expenses Tab */}
            {activeTab === 'expenses' && (
              <div className="h-full flex flex-col pt-4 overflow-hidden relative">
                <div className="px-4 pb-2">
                    <div className="bg-[#FFF8E1] p-3 rounded-2xl border-2 border-[#FFE0B2] shadow-sm flex justify-between items-center">
                        <div><div className="text-xs text-[#F57C00] font-bold">ç¸½èŠ±è²» (å°å¹£)</div><div className="text-2xl font-black text-[#E65100]">${totalSpentConvertedTWD.toLocaleString()}</div></div>
                        <div className="text-right"><div className="text-xs text-[#F57C00] font-bold">ç´„åˆæ—¥å¹£</div><div className="text-xl font-black text-[#FF9800]">Â¥{Math.round(totalSpentConvertedTWD / getExchangeRate('JPY')).toLocaleString()}</div></div>
                    </div>
                </div>
                <div className="px-4 mb-2">
                    <div className="bg-white rounded-2xl shadow-md border-2 border-[#FF6B6B] p-3">
                        {showPlatformManager && (
                            <div className="mb-3 p-2 bg-gray-50 rounded-xl border border-gray-200">
                                <div className="flex justify-between mb-2"><h4 className="text-xs font-bold text-gray-600">ç®¡ç†å¹³å°</h4><button onClick={() => setShowPlatformManager(false)}><Icons.X size={16}/></button></div>
                                <div className="flex gap-2 mb-2"><input value={newPlatformName} onChange={e => setNewPlatformName(e.target.value)} placeholder="æ–°å¢..." className="flex-1 bg-white border border-gray-300 rounded px-2 py-1 text-sm"/><button onClick={addBookingPlatform} className="bg-[#4ECDC4] text-white px-2 rounded text-xs font-bold">æ–°å¢</button></div>
                                <div className="flex flex-wrap gap-1 max-h-20 overflow-y-auto">{bookingPlatforms.map(p => (<div key={p} className="bg-white border px-2 py-0.5 rounded text-[10px] font-bold flex items-center gap-1">{p} <button onClick={() => deleteBookingPlatform(p)} className="text-red-400"><Icons.X size={10}/></button></div>))}</div>
                            </div>
                        )}
                        <div className="flex gap-2 mb-2">
                             <input type="date" value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="bg-gray-50 rounded-lg px-2 py-2 outline-none text-sm font-bold w-32 border border-gray-200 text-gray-600" />
                             <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="bg-gray-50 rounded-lg px-2 py-2 outline-none text-sm font-bold flex-1 border border-gray-200">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                             <select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="bg-gray-50 rounded-lg px-2 py-2 outline-none text-xs font-bold w-20 border border-gray-200 text-gray-500">{paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}</select>
                        </div>
                        <div className="flex gap-2 mb-2">
                            <div className="relative w-24 shrink-0">
                                <select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="w-full bg-gray-50 rounded-lg pl-2 pr-6 py-2 outline-none text-xs font-bold border border-gray-200 appearance-none h-10">{bookingPlatforms.map(p => <option key={p} value={p}>{p}</option>)}</select>
                                <button onClick={() => setShowPlatformManager(!showPlatformManager)} className="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 p-1"><Icons.Settings size={12}/></button>
                            </div>
                            <input type="text" placeholder="å“é …..." value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="flex-1 bg-transparent border-b-2 border-dashed border-gray-300 outline-none text-base font-bold text-gray-800 h-10 px-1" />
                        </div>
                        <div className="flex gap-2 items-center">
                            <div className="flex-1 flex items-center bg-gray-50 rounded-lg border-2 border-[#FFCCBC] px-2 h-12">
                                <input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="w-full bg-transparent font-black text-2xl outline-none text-[#E64A19]" />
                                <select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})} className="bg-transparent outline-none font-bold text-xs w-20 text-gray-500 text-right">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.flag} {c.code}</option>)}</select>
                            </div>
                            <button onClick={handleDirectAddExpense} className="bg-[#FF9F43] text-white w-12 h-12 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center shrink-0"><Icons.Plus size={28}/></button>
                        </div>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto no-scrollbar pb-24 px-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {(expenseFilter === 'all' ? expenses : expenses.filter(e => e.date === expenseFilter)).slice().reverse().map(expense => (
                        <div key={expense.id} className="bg-white p-3 rounded-2xl border-2 border-gray-100 shadow-sm flex justify-between items-center h-20 animate-in fade-in slide-in-from-bottom-2">
                        <div className="flex-1 overflow-hidden"><div className="text-xs text-gray-500 font-bold mb-1">{formatDate(expense.date)} â€¢ {expense.category}</div><div className="text-lg font-bold text-gray-900 truncate pr-2">{expense.item}</div><div className="text-xs text-gray-400 font-bold mt-1">{expense.method} {expense.platform ? `/ ${expense.platform}` : ''}</div></div>
                        <div className="text-right shrink-0"><div className="text-xl font-bold text-[#FF9F43]">{CURRENCIES.find(c => c.code === expense.currency)?.flag} {CURRENCIES.find(c => c.code === expense.currency)?.symbol}{expense.amount.toLocaleString()}</div>{expense.currency !== 'TWD' && <div className="text-xs text-gray-400 font-bold">â‰ˆ ${Math.round(expense.amount * getExchangeRate(expense.currency))}</div>}<button onClick={() => handleDeleteExpense(expense.id)} className="text-gray-300 hover:text-red-400 mt-1 p-2"><Icons.Trash2 size={16} /></button></div></div>
                    ))}
                    </div>
                </div>
              </div>
            )}

            {activeTab === 'shopping' && (
              <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                <div className="flex gap-2 text-white mb-4">
                    <div className="flex-1 bg-[#FF6B81] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ğŸ™†â€â™€ï¸ è‡ªç”¨</div><div className="font-bold text-2xl">${shoppingStats.selfTotal.toLocaleString()}</div></div>
                    <div className="flex-1 bg-[#6C5CE7] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ğŸ“¦ ä»£è³¼æ”¶</div><div className="font-bold text-2xl text-white">${shoppingStats.agentTotal.toLocaleString()}</div></div>
                </div>
                {Object.keys(agentSummary).length > 0 && (
                    <div className="bg-[#E8EAF6] p-4 rounded-2xl border-2 border-[#C5CAE9] mb-4 shadow-sm">
                        <h3 className="font-bold text-[#3949AB] mb-2 flex items-center gap-2"><Icons.Coins size={20}/> ä»£è³¼çµç®— (æ¯äººç¸½è¨ˆ)</h3>
                        <div className="space-y-2">
                            {Object.entries(agentSummary).map(([name, totals]) => (
                                <div key={name} className="flex justify-between items-center bg-white/60 p-2 rounded-xl">
                                    <span className="font-bold text-gray-700">{name}</span>
                                    <div className="text-right">
                                        <div className="text-lg font-black text-[#3949AB]">${totals.totalTWD.toLocaleString()}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}
                <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                    <div className="flex bg-gray-100 p-1 rounded-xl mb-3 border-2 border-gray-200">
                        {['self', 'agent', 'split'].map(type => ( <button key={type} onClick={() => setNewShopItem({...newShopItem, type})} className={`flex-1 py-2 rounded-lg text-lg font-bold transition-all ${newShopItem.type === type ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{type === 'self' ? 'è‡ªç”¨' : type === 'agent' ? 'ä»£è³¼' : 'åˆ†å¸³'}</button> ))}
                    </div>
                    <div className="flex gap-2 mb-2"><button onClick={() => { setBatchType('shopping'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 rounded-xl font-bold mb-1 border-2 border-[#80CBC4] flex items-center justify-center gap-2"><Icons.ListPlus size={20}/> æ‰¹æ¬¡åŒ¯å…¥</button></div>
                    <div className="flex gap-3 mb-3">
                        <select value={newShopItem.priority} onChange={e => setNewShopItem({...newShopItem, priority: e.target.value})} className="bg-gray-50 border-2 border-gray-200 rounded-xl px-2 outline-none text-base font-bold w-32"><option value="high">ğŸ”´ å¿…è²·</option><option value="medium">ğŸŸ¡ é¸è³¼</option><option value="low">ğŸŸ¢ å¯è²·</option></select>
                        <input placeholder="æˆ°åˆ©å“åç¨±..." value={newShopItem.item} onChange={e => setNewShopItem({...newShopItem, item: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none font-bold text-xl text-gray-800" />
                    </div>
                    <div className="flex gap-2 mb-3">
                        <input type="number" placeholder="é‡‘é¡" value={newShopItem.budget} onChange={e => setNewShopItem({...newShopItem, budget: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none text-xl font-bold" />
                        <select value={newShopItem.currency} onChange={e => setNewShopItem({...newShopItem, currency: e.target.value})} className="bg-gray-50 border-2 border-gray-200 rounded-xl px-2 outline-none font-bold w-28">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.flag} {c.code}</option>)}</select>
                    </div>
                    {(newShopItem.type === 'agent' || newShopItem.type === 'split') && ( <div className="flex gap-3 mb-3 animate-in fade-in">{newShopItem.type === 'agent' && <input placeholder="å¹«èª°è²·?" value={newShopItem.note} onChange={e => setNewShopItem({...newShopItem, note: e.target.value})} className="flex-1 bg-[#EDE7F6] border-2 border-[#6C5CE7] rounded-xl px-4 py-3 outline-none text-[#6C5CE7] font-bold text-lg" />}{newShopItem.type === 'split' && <div className="flex-1 flex items-center bg-[#FFF3E0] border-2 border-[#FFA502] rounded-xl px-4 text-[#FFA502] font-bold"><span className="text-sm mr-2">äººæ•¸:</span><input type="number" value={newShopItem.splitCount} onChange={e => setNewShopItem({...newShopItem, splitCount: e.target.value})} className="w-full bg-transparent outline-none text-xl" /></div>}</div> )}
                    <button onClick={handleAddShoppingItem} className="w-full bg-[#FF6B81] text-white py-3 rounded-2xl border-2 border-black korean-3d-btn font-bold text-xl flex items-center justify-center gap-2 mt-2"><Icons.Plus size={24}/> åŠ å…¥æ¸…å–®</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {shoppingList.filter(i => !i.bought).map(item => (
                    <div key={item.id} className="bg-white p-4 rounded-2xl border-4 shadow-sm flex items-center justify-between" style={{ borderColor: item.type === 'agent' ? '#6C5CE7' : item.type === 'split' ? '#FFA502' : '#FF6B81' }}>
                        <div className="flex items-center gap-4 cursor-pointer w-full" onClick={() => toggleShoppingItem(item.id)}>
                            <div className={`w-4 h-full self-stretch rounded-full ${item.type === 'agent' ? 'bg-[#6C5CE7]' : item.type === 'split' ? 'bg-[#FFA502]' : 'bg-[#FF6B81]'}`}></div>
                            <div className="flex-1 overflow-hidden">
                                <div className="flex items-center gap-2"><span className={`text-xs px-2 py-1 rounded-lg shrink-0 text-white font-bold shadow-sm ${item.priority === 'high' ? 'bg-red-500' : item.priority === 'medium' ? 'bg-yellow-400' : 'bg-green-400'}`}>{item.priority === 'high' ? 'å¿…è²·' : item.priority === 'medium' ? 'é¸è³¼' : 'å¯è²·'}</span><span className="font-bold text-xl text-gray-800 truncate">{item.item}</span></div>
                                <div className="text-sm text-gray-500 font-bold mt-1 flex items-center gap-2"><span className="bg-gray-100 px-2 rounded">{CURRENCIES.find(c=>c.code===(item.currency||'JPY'))?.flag} {CURRENCIES.find(c=>c.code===(item.currency||'JPY'))?.symbol}{item.budget.toLocaleString()}</span><span className="text-gray-300">âœ</span><span className="text-gray-900 font-bold text-lg">{item.type === 'split' ? `$${Math.round((item.budget * getExchangeRate(item.currency||'JPY')) / item.splitCount)} /äºº` : `$${Math.round(item.budget * getExchangeRate(item.currency||'JPY'))}`}</span></div>
                                {(item.type === 'agent' || item.type === 'split') && ( <div className="text-xs font-bold text-gray-400 mt-2 bg-gray-50 w-fit px-2 py-1 rounded">{item.type === 'agent' ? `çµ¦: ${item.note}` : `${item.splitCount}äººåˆ†å¸³`}</div> )}
                            </div>
                        </div>
                        <div className="flex flex-col gap-2">
                            {/* V36 Shop to Expense Button */}
                            <button onClick={(e) => handleShopToExpense(e, item)} className="text-white bg-[#FF9F43] p-2 rounded-xl hover:bg-[#FFB74D] shadow-sm flex items-center justify-center"><Icons.Coins size={20}/></button>
                            <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 p-2 shrink-0 hover:text-red-400"><Icons.Trash2 size={24}/></button>
                        </div>
                    </div>
                  ))}
                </div>
                {shoppingList.filter(i => i.bought).length > 0 && <div className="text-gray-400 text-lg font-bold mt-6 mb-3 border-b-2 border-gray-200 pb-1">å·²è³¼è²·å®Œæˆ</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">{shoppingList.filter(i => i.bought).map(item => (<div key={item.id} onClick={() => toggleShoppingItem(item.id)} className="bg-gray-100 p-3 rounded-xl border-2 border-gray-200 flex items-center gap-3 opacity-60"><Icons.Check size={20} className="text-gray-500"/><span className="line-through text-gray-500 font-bold text-lg">{item.item}</span></div>))}</div>
              </div>
            )}
            
            {activeTab === 'packing' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                    <div className="bg-white p-4 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                        <div className="flex gap-2">
                            <input value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="æ–°å¢åˆ†é¡åç¨± (å¦‚: æ”å½±è£å‚™)..." className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                            <button onClick={addPackingCategory} className="bg-[#6C5CE7] text-white px-4 rounded-xl font-bold flex items-center"><Icons.Plus size={20}/> åˆ†é¡</button>
                        </div>
                    </div>
                    <div className="space-y-6">
                        {packingCategories.map(cat => {
                            const items = packingList.filter(i => i.category === cat);
                            return (
                                <div key={cat} className="animate-in fade-in slide-in-from-bottom-2">
                                    <div className="flex justify-between items-center mb-3 ml-2">
                                        <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><span className="w-2 h-6 bg-[#FF6B6B] rounded-full"></span>{cat}</h3>
                                        <div className="flex gap-2">
                                            <button onClick={() => setActivePackingCategory(activePackingCategory === cat ? null : cat)} className={`p-1 rounded-lg border-2 ${activePackingCategory === cat ? 'bg-[#FF6B6B] text-white border-[#FF6B6B]' : 'bg-white text-gray-400 border-gray-300'}`}><Icons.Plus size={18}/></button>
                                            <button onClick={() => deletePackingCategory(cat)} className="text-gray-300 hover:text-red-400 p-1"><Icons.Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                    {activePackingCategory === cat && (
                                        <div className="flex gap-2 mb-3 px-1">
                                            <input autoFocus value={newPackingItemText} onChange={e => setNewPackingItemText(e.target.value)} placeholder={`æ–°å¢ç‰©å“åˆ° ${cat}...`} className="flex-1 bg-white border-2 border-[#FF6B6B] rounded-xl px-3 py-2 outline-none font-bold text-lg" />
                                            <button onClick={() => addPackingItemToCategory(cat)} className="bg-[#FF6B6B] text-white px-4 rounded-xl font-bold">åŠ å…¥</button>
                                        </div>
                                    )}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {items.map(item => (
                                            <div key={item.id} onClick={() => togglePackingItem(item.id)} className={`p-4 rounded-2xl border-2 flex items-center justify-between transition-all cursor-pointer ${item.checked ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-200 shadow-sm'}`}>
                                                <div className="flex items-center gap-4"><div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.checked ? 'bg-[#4ECDC4] border-[#4ECDC4]' : 'border-gray-300'}`}>{item.checked && <Icons.Check size={16} className="text-white"/>}</div><span className={`text-xl font-thin-hand ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}`}>{item.item}</span></div>
                                                <button onClick={(e) => { e.stopPropagation(); deletePackingItem(item.id); }} className="text-gray-300 hover:text-red-400 p-2"><Icons.Trash2 size={20}/></button>
                                            </div>
                                        ))}
                                        {items.length === 0 && <div className="text-gray-400 text-sm italic p-2">æš«ç„¡ç‰©å“</div>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )}

            {/* Info Tab - V36 Enhanced */}
            {activeTab === 'info' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                    
                    {/* Add Memo Modal - Dynamic Content */}
                    {activeMemoSection && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setActiveMemoSection(null)}>
                            <div className="bg-white w-11/12 max-w-sm rounded-3xl p-5 fade-in max-h-[85vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">æ–°å¢: {MEMO_SECTIONS.find(s=>s.id===activeMemoSection)?.label}</h3>
                                <div className="space-y-3">
                                    <input type="date" value={newMemo.date} onChange={e => setNewMemo({...newMemo, date: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg text-gray-800" />
                                    
                                    {/* Flight Fields */}
                                    {activeMemoSection === 'flight' && (
                                        <>
                                            <input placeholder="é ç´„é …ç›® (å¦‚: æ¨‚æ¡ƒ MM860)" value={newMemo.title} onChange={e => setNewMemo({...newMemo, title: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                                            <div className="flex gap-2">
                                                <input placeholder="é ç´„ä»£è™Ÿ" value={newMemo.bookingRef} onChange={e => setNewMemo({...newMemo, bookingRef: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold" />
                                                <input placeholder="åº§ä½" value={newMemo.seat} onChange={e => setNewMemo({...newMemo, seat: e.target.value})} className="w-24 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold" />
                                            </div>
                                        </>
                                    )}

                                    {/* Hotel Fields */}
                                    {activeMemoSection === 'hotel' && (
                                        <>
                                            <input placeholder="é£¯åº—åç¨±" value={newMemo.title} onChange={e => setNewMemo({...newMemo, title: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                                            <input placeholder="åœ°å€ (æä¾›å°èˆª)" value={newMemo.address} onChange={e => setNewMemo({...newMemo, address: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold" />
                                            <input placeholder="è¨‚å–®ç·¨è™Ÿ" value={newMemo.bookingRef} onChange={e => setNewMemo({...newMemo, bookingRef: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold" />
                                            <div onClick={() => triggerFileAction('memo', 'new')} className="w-full h-32 border-4 border-dashed border-gray-300 rounded-xl flex items-center justify-center cursor-pointer hover:bg-gray-50 relative overflow-hidden">
                                                {newMemo.image ? <img src={newMemo.image} className="w-full h-full object-cover" /> : <div className="text-gray-400 font-bold flex flex-col items-center"><Icons.Camera size={24}/><span>ä¸Šå‚³æ†‘è­‰ç…§ç‰‡</span></div>}
                                            </div>
                                        </>
                                    )}

                                    {/* Food Fields */}
                                    {activeMemoSection === 'food' && (
                                        <>
                                            <input placeholder="é¤å»³åç¨±" value={newMemo.title} onChange={e => setNewMemo({...newMemo, title: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                                            <input placeholder="åœ°å€/é€£çµ (æä¾›å°èˆª)" value={newMemo.address} onChange={e => setNewMemo({...newMemo, address: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold" />
                                            <div onClick={() => triggerFileAction('memo', 'new')} className="w-full h-32 border-4 border-dashed border-gray-300 rounded-xl flex items-center justify-center cursor-pointer hover:bg-gray-50 relative overflow-hidden">
                                                {newMemo.image ? <img src={newMemo.image} className="w-full h-full object-cover" /> : <div className="text-gray-400 font-bold flex flex-col items-center"><Icons.Camera size={24}/><span>ä¸Šå‚³èœå–®/å¤–è§€</span></div>}
                                            </div>
                                        </>
                                    )}

                                    {/* Note Fields */}
                                    {activeMemoSection === 'note' && (
                                        <>
                                            <input placeholder="æ¨™é¡Œ (é¸å¡«)..." value={newMemo.title} onChange={e => setNewMemo({...newMemo, title: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                                            <textarea placeholder="å…§å®¹..." value={newMemo.content} onChange={e => setNewMemo({...newMemo, content: e.target.value})} className="w-full h-24 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg text-gray-800"></textarea>
                                            <div onClick={() => triggerFileAction('memo', 'new')} className="w-full h-32 border-4 border-dashed border-gray-300 rounded-xl flex items-center justify-center cursor-pointer hover:bg-gray-50 relative overflow-hidden">
                                                {newMemo.image ? <img src={newMemo.image} className="w-full h-full object-cover" /> : <div className="text-gray-400 font-bold flex flex-col items-center"><Icons.Camera size={24}/><span>ä¸Šå‚³æˆªåœ–/ç…§ç‰‡</span></div>}
                                            </div>
                                        </>
                                    )}

                                    {/* Generic Textarea */}
                                    {activeMemoSection === 'flight' && (
                                        <textarea placeholder="å‚™è¨»..." value={newMemo.content} onChange={e => setNewMemo({...newMemo, content: e.target.value})} className="w-full h-24 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg text-gray-800"></textarea>
                                    )}
                                    {activeMemoSection === 'hotel' && (
                                        <textarea placeholder="å‚™è¨»..." value={newMemo.content} onChange={e => setNewMemo({...newMemo, content: e.target.value})} className="w-full h-20 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg text-gray-800"></textarea>
                                    )}
                                    {activeMemoSection === 'food' && (
                                        <textarea placeholder="å‚™è¨» (æ¨è–¦èœè‰²?)..." value={newMemo.content} onChange={e => setNewMemo({...newMemo, content: e.target.value})} className="w-full h-20 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg text-gray-800"></textarea>
                                    )}
                                    
                                    <button onClick={() => handleAddMemo(activeMemoSection)} className="w-full bg-[#5C6BC0] text-white font-bold py-3 rounded-xl korean-3d-btn">ç¢ºå®šæ–°å¢</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {MEMO_SECTIONS.map(section => {
                            const sectionMemos = memos.filter(m => m.category === section.id).sort((a,b)=>new Date(a.date)-new Date(b.date));
                            return (
                                <div key={section.id} className={`bg-white rounded-3xl p-4 border-l-8 shadow-sm ${section.color}`}>
                                    <div className="flex justify-between items-center mb-4 border-b pb-2 border-gray-100">
                                        <h3 className={`font-black text-xl flex items-center gap-2 ${section.text}`}>
                                            <div className={`p-2 rounded-xl ${section.bg}`}>{section.icon}</div>
                                            {section.label}
                                        </h3>
                                        <button onClick={() => { setNewMemo({ date: itinerary[0]?.date || '2026-02-02', category: '', title: '', content: '', bookingRef: '', seat: '', address: '', image: null }); setActiveMemoSection(section.id); }} className={`w-8 h-8 rounded-full flex items-center justify-center text-white shadow-sm hover:scale-110 transition-transform ${section.bg.replace('bg-', 'bg-').replace('-50', '-400')}`}>
                                            <Icons.Plus size={20}/>
                                        </button>
                                    </div>
                                    
                                    <div className="space-y-3 min-h-[100px]">
                                        {sectionMemos.length > 0 ? sectionMemos.map(memo => (
                                            <div key={memo.id} className="relative group bg-gray-50 p-3 rounded-xl border border-gray-100 hover:shadow-md transition-all">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-xs font-bold text-gray-400 bg-white px-2 py-0.5 rounded border border-gray-200 inline-block">{formatDate(memo.date)} ({getWeekday(memo.date)})</span>
                                                    <button onClick={() => deleteMemo(memo.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                                </div>
                                                
                                                <div className="font-black text-gray-800 text-lg mb-1">{memo.title || (section.id === 'note' && !memo.content ? 'ç­†è¨˜' : '')}</div>
                                                
                                                {section.id === 'flight' && (
                                                    <div className="flex gap-2 flex-wrap mb-2">
                                                        {memo.bookingRef && <span className="bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded font-bold">ä»£è™Ÿ: {memo.bookingRef}</span>}
                                                        {memo.seat && <span className="bg-green-100 text-green-600 text-xs px-2 py-1 rounded font-bold">åº§ä½: {memo.seat}</span>}
                                                    </div>
                                                )}

                                                {(section.id === 'hotel' || section.id === 'food') && (
                                                    <div className="mb-2">
                                                        {memo.address && <button onClick={(e) => openGoogleMaps(e, memo.address)} className={`text-xs font-bold text-white px-2 py-1 rounded flex items-center gap-1 w-fit mb-1 ${section.id==='hotel'?'bg-indigo-400 hover:bg-indigo-500':'bg-orange-400 hover:bg-orange-500'}`}><Icons.Navigation size={12}/> å°èˆª</button>}
                                                        {memo.bookingRef && <div className="text-xs font-bold text-gray-500">è¨‚å–®: {memo.bookingRef}</div>}
                                                    </div>
                                                )}

                                                {memo.content && (
                                                    <div className={`text-sm text-gray-600 ${section.id === 'note' && !memo.title ? 'text-lg font-bold text-gray-800' : ''} whitespace-pre-wrap`}>{memo.content}</div>
                                                )}
                                                
                                                {memo.image && (
                                                    <div className="mt-2 relative group-image">
                                                        <img src={memo.image} className="w-full h-32 object-cover rounded-lg border border-gray-200" />
                                                        <a href={memo.image} download={`memo_${memo.id}.jpg`} className="absolute bottom-2 right-2 bg-black/50 text-white p-1 rounded hover:bg-black/70"><Icons.Download size={16}/></a>
                                                    </div>
                                                )}
                                            </div>
                                        )) : (
                                            <div className="h-full flex items-center justify-center text-gray-300 font-bold italic text-sm py-4">é»æ“Š + æ–°å¢{section.label}</div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            )}
          </div>

          <div className="bg-white border-t-2 border-gray-100 shrink-0 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] grid grid-cols-5 gap-1 p-2 h-24 items-end pb-6 z-50 relative">
            <TabButton id="itinerary" IconComp={Icons.Map} label="è¡Œç¨‹" bgColor="#FFECF2" activeColor="#FF6B81" />
            <TabButton id="expenses" IconComp={Icons.Coins} label="è¨˜å¸³" bgColor="#FFF8E1" activeColor="#FFB74D" />
            <TabButton id="shopping" IconComp={Icons.ShoppingBag} label="æˆ°åˆ©å“" bgColor="#E0F2F1" activeColor="#4DB6AC" />
            <TabButton id="packing" IconComp={Icons.Suitcase} label="è¡Œæ" bgColor="#F3E5F5" activeColor="#BA68C8" />
            <TabButton id="info" IconComp={Icons.Info} label="è³‡è¨Š" bgColor="#E8EAF6" activeColor="#5C6BC0" />
          </div>

        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

