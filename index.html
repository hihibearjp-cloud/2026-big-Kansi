<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026å¤§é—œè¥¿ðŸ¦€æ•£ç­– V34 (âœ¨Gemini AIç‰ˆ)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS & Tesseract -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#FF6B6B">

  <!-- Dynamic Icon Targets -->
  <link id="app-icon" rel="apple-touch-icon" href="">
  <link id="fav-icon" rel="icon" type="image/png" href="">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Hi+Melody&display=swap');
    
    body { 
      font-family: 'Gaegu', cursive; 
      background-color: #E0F7FA; 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior-y: none; 
      user-select: none;
      font-weight: 700;
      color: #2d3436;
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); background-color: #FF6B6B; }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 20px); background-color: white; }
    
    .korean-3d-btn { transition: all 0.1s; box-shadow: 0px 3px 0px 0px rgba(0,0,0,0.15); transform: translateY(0); }
    .korean-3d-btn:active { transform: translateY(3px); box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.15); }
    
    .font-thin-hand { font-family: 'Gaegu', cursive; font-weight: 300 !important; }
    
    .paper-texture { background-color: #fffbf0; background-image: radial-gradient(#d4c5a6 0.8px, transparent 0.8px); background-size: 12px 12px; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    input, select, textarea { font-size: 18px !important; font-family: 'Gaegu', cursive; font-weight: 700; }
    
    .snap-x-mandatory { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .loading-spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- Print / Booklet Styles --- */
    @media print {
      body * { visibility: hidden; }
      #booklet-root, #booklet-root * { visibility: visible; }
      #booklet-root { 
        position: absolute; left: 0; top: 0; width: 100%; 
        background: white; color: black; z-index: 9999;
        overflow: visible; height: auto;
      }
      .page-break { page-break-before: always; }
      .avoid-break { page-break-inside: avoid; }
      body { background: white; height: auto; overflow: visible; }
      .safe-area-top, .safe-area-bottom, .modal-backdrop { display: none !important; }
    }
    
    .booklet-page {
        width: 100%; max-width: 210mm; margin: 0 auto; padding: 20px;
        background: white; box-sizing: border-box; min-height: 297mm; position: relative;
    }
    .print-hidden { display: none; }
    @media print { .print-hidden { display: block; } }
    
    .sparkle-btn {
        background: linear-gradient(45deg, #FF6B6B, #FFD93D);
        color: white;
        border: 2px solid white;
        box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
    }
  </style>
</head>
<body class="overflow-hidden bg-[#E0F7FA]">
  <div id="root" class="h-full w-full"></div>

  <!-- Icon Generation -->
  <script>
    window.addEventListener('load', function() {
      try {
        const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#FF6B6B" rx="100"/><circle cx="100" cy="100" r="15" fill="white" opacity="0.6"/><circle cx="400" cy="80" r="10" fill="white" opacity="0.6"/><circle cx="50" cy="400" r="12" fill="white" opacity="0.6"/><circle cx="450" cy="450" r="18" fill="white" opacity="0.6"/><circle cx="256" cy="50" r="8" fill="white" opacity="0.8"/><path fill="#B71C1C" d="M106 130h30v-40h-20v-20h20c0-20 10-40 40-40h160c30 0 40 20 40 40h20v20h-20v40h30v30h-30v250h30v30H106v-30h30V160h-30z"/><rect x="136" y="180" width="240" height="30" fill="#B71C1C"/><path d="M140 220 Q 256 280 372 220" stroke="#FBC02D" stroke-width="20" fill="none" stroke-linecap="round"/><g transform="translate(156, 280)"><path fill="#FFCDD2" d="M20 100 C-20 60 -20 20 20 20 L 40 40 L 60 20 C 100 20 100 60 60 100 Z" /><path fill="#FFCDD2" d="M180 100 C 220 60 220 20 180 20 L 160 40 L 140 20 C 100 20 100 60 140 100 Z" /><ellipse cx="100" cy="120" rx="90" ry="60" fill="#FFCDD2" /><circle cx="70" cy="110" r="10" fill="#333"/><circle cx="130" cy="110" r="10" fill="#333"/><path d="M70 140 Q 100 160 130 140" stroke="#B71C1C" stroke-width="5" fill="none" stroke-linecap="round"/></g></svg>`;
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d'); const img = new Image(); img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
        img.onload = function() { ctx.drawImage(img, 0, 0); const pngUrl = canvas.toDataURL('image/png'); document.getElementById('app-icon').href = pngUrl; document.getElementById('fav-icon').href = pngUrl; };
      } catch(e) { console.warn("Icon gen failed", e); }
    });
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const apiKey = ""; // API Key injected by environment

    // --- Gemini API Helper ---
    const callGeminiAPI = async (prompt) => {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        
        const delays = [1000, 2000, 4000, 8000, 16000];
        for (let i = 0; i < 5; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                if (i === 4) throw error;
                await new Promise(resolve => setTimeout(resolve, delays[i]));
            }
        }
    };

    // --- Icons ---
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>,
      ShoppingBag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Map: (p) => <Icon {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Coins: (p) => <Icon {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>,
      Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
      X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
      FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
      Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
      Refresh: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>,
      Navigation: (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/></Icon>,
      Loader: (p) => <Icon {...p}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></Icon>,
      Image: (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>,
      Suitcase: (p) => <Icon {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
      Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      Utensils: (p) => <Icon {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      ListPlus: (p) => <Icon {...p}><path d="M11 12H3"/><path d="M16 6H3"/><path d="M16 18H3"/><path d="M18 9v6"/><path d="M21 12h-6"/></Icon>,
      Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
      CloudSun: (p) => <Icon {...p}><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></Icon>,
      ArrowUp: (p) => <Icon {...p}><path d="m18 15-6-6-6 6"/></Icon>,
      ArrowDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
      Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
      User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
      Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></Icon>,
      Phone: (p) => <Icon {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></Icon>,
      Ticket: (p) => <Icon {...p}><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h.01M18 12h.01"/></Icon>,
      Bed: (p) => <Icon {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></Icon>,
      Book: (p) => <Icon {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>,
      Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
      Sparkles: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 17v4"/><path d="M15 19h4"/></Icon>,
    };

    // --- Data ---
    const INITIAL_ITINERARY = [
      { 
        id: 1, date: '2026-02-02', weekday: 'æ—¥', 
        content: '', transport: 'åé–€å¤§æ´‹æ¸¡è¼ª', stay: 'èˆ¹ä¸Š', food: 'èˆ¹ä¸Šè‡ªåŠ©é¤', highlights: 'æ¬£è³žç€¨æˆ¶å…§æµ·å¤œæ™¯', photo: null,
        schedule: [
            { id: 101, time: '15:00', category: 'äº¤é€š', activity: 'å‰å¾€å—æ¸¯æ¸¡è¼ªç«™', note: 'ææ—©check-in' },
            { id: 102, time: '17:00', category: 'äº¤é€š', activity: 'åé–€å¤§æ´‹æ¸¡è¼ª å‡ºç™¼', note: 'æ¬£è³žå¤•é™½' }
        ]
      },
      { 
        id: 2, date: '2026-02-03', weekday: 'ä¸€', 
        content: '', transport: 'JR / æ­¥è¡Œ', stay: 'ç¦å²¡ Quintessa', food: 'ç‡’å’–å“©', highlights: 'æ‡·èˆŠå»ºç¯‰ã€å°å€‰åŸŽ', photo: null,
        schedule: [
            { id: 201, time: '08:30', category: 'äº¤é€š', activity: 'æŠµé”é–€å¸æ¸¯', note: 'ä¸‹èˆ¹' },
            { id: 202, time: '10:00', category: 'æ™¯é»ž', activity: 'é–€å¸æ¸¯æ‡·èˆŠå€', note: 'æ‹ç…§' }
        ]
      },
    ];

    const INITIAL_SHOPPING = [
      { id: 1, item: 'åˆåˆ©ä»–å‘½', budget: 5000, bought: false, store: 'æ¾æœ¬æ¸…', priority: 'high', type: 'self', note: '' },
    ];
    
    const INITIAL_PACKING_CATEGORIES = ['é‡è¦è­‰ä»¶ & éš¨èº«', 'æ´—æ¼± & è­·ç†', 'é†«è—¥ & ä¿å¥', 'ç¾Žå¦ & ä¿é¤Š', 'è¡£ç‰© & ç©¿æ­', 'é›»å­ & é›œç‰©'];

    const INITIAL_PACKING_LIST = [
        { id: 101, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'è­·ç…§ / ç°½è­‰', checked: false },
        { id: 102, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'æ©Ÿç¥¨ / æ†‘è­‰ (VJWæˆªåœ–)', checked: false },
        { id: 103, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'éŒ¢åŒ… (ç¾é‡‘/ä¿¡ç”¨å¡)', checked: false },
        { id: 104, category: 'é‡è¦è­‰ä»¶ & éš¨èº«', item: 'è¡Œå‹•é›»æº', checked: false },
        { id: 501, category: 'è¡£ç‰© & ç©¿æ­', item: 'æ›æ´—è¡£ç‰©', checked: false },
    ];
    
    const INITIAL_PAYMENT_METHODS = ['ç¾é‡‘', 'ä¿¡ç”¨å¡(ä¸­ä¿¡)', 'ä¿¡ç”¨å¡(å¯Œé‚¦J)', 'è¥¿ç“œå¡'];
    const INITIAL_BOOKING_PLATFORMS = ['ç¾å ´', 'Agoda', 'Booking', 'å®˜ç¶²', 'Klook', 'æ±æ©«INN'];
    const CATEGORIES = ['ðŸœ é£²é£Ÿ', 'ðŸšƒ äº¤é€š', 'ðŸ¨ ä½å®¿', 'ðŸ›ï¸ è³¼ç‰©', 'ðŸŽ« é–€ç¥¨', 'ðŸ“ å…¶ä»–'];
    const SCHEDULE_CATEGORIES = [
        { name: 'æ™¯é»ž', color: '#E64A19' },
        { name: 'åƒé£¯', color: '#F57C00' },
        { name: 'é€›è¡—', color: '#C2185B' },
        { name: 'äº¤é€š', color: '#455A64' },
        { name: 'ä½å®¿', color: '#303F9F' },
        { name: 'å½ˆæ€§', color: '#00796B' },
    ];
    
    const CITIES = ['å¤§é˜ª', 'äº¬éƒ½', 'ç¥žæˆ¶', 'å¥ˆè‰¯', 'å§¬è·¯', 'å®‡æ²»', 'å…¶ä»–'];

    const CURRENCIES = [
        { code: 'JPY', label: 'ðŸ‡¯ðŸ‡µ JPY', symbol: 'Â¥' },
        { code: 'TWD', label: 'ðŸ‡¹ðŸ‡¼ TWD', symbol: '$' },
        { code: 'USD', label: 'ðŸ‡ºðŸ‡¸ USD', symbol: '$' },
        { code: 'KRW', label: 'ðŸ‡°ðŸ‡· KRW', symbol: 'â‚©' },
        { code: 'EUR', label: 'ðŸ‡ªðŸ‡º EUR', symbol: 'â‚¬' },
    ];
    const BUTTON_COLORS = ['#FF9F43', '#4ECDC4', '#FF6B6B', '#6C5CE7', '#FFA502'];

    // --- Weather Component ---
    const WeatherWidget = () => {
        const [weather, setWeather] = useState(null);
        const [time, setTime] = useState(new Date());

        useEffect(() => {
            const timer = setInterval(() => setTime(new Date()), 60000);
            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.6937&longitude=135.5023&current_weather=true');
                    const data = await res.json();
                    setWeather(data.current_weather);
                } catch (e) { console.warn("Weather fetch failed"); }
            };
            fetchWeather();
            return () => clearInterval(timer);
        }, []);

        return (
            <div className="flex gap-2 items-center text-white text-xs font-bold bg-black/20 rounded-lg px-2 py-1">
                <span>{time.getHours().toString().padStart(2,'0')}:{time.getMinutes().toString().padStart(2,'0')}</span>
                <span className="w-[1px] h-3 bg-white/50"></span>
                <span>{weather ? `${weather.temperature}Â°C` : '...'}</span>
            </div>
        );
    };

    // --- Main App ---
    function App() {
      // Keys
      const loadState = (key, defaultVal) => {
        try { 
            const val = localStorage.getItem(key);
            if (val === null) return defaultVal;
            const parsed = JSON.parse(val);
            if (Array.isArray(defaultVal) && !Array.isArray(parsed)) return defaultVal;
            return parsed;
        } catch (e) { return defaultVal; }
      };

      const saveState = (key, value) => {
          try { localStorage.setItem(key, JSON.stringify(value)); } 
          catch (e) { console.warn("Storage Full", e); }
      };

      const [activeTab, setActiveTab] = useState('itinerary');
      
      const [itinerary, setItinerary] = useState(() => loadState('crab_itinerary_v23', INITIAL_ITINERARY));
      const [expenses, setExpenses] = useState(() => loadState('crab_expenses_v23', []));
      const [shoppingList, setShoppingList] = useState(() => loadState('crab_shopping_v23', INITIAL_SHOPPING));
      const [packingList, setPackingList] = useState(() => loadState('crab_packing_v23', INITIAL_PACKING_LIST));
      const [packingCategories, setPackingCategories] = useState(() => loadState('crab_packing_cats_v23', INITIAL_PACKING_CATEGORIES));
      const [paymentMethods, setPaymentMethods] = useState(() => loadState('crab_methods_v23', INITIAL_PAYMENT_METHODS));
      const [bookingPlatforms, setBookingPlatforms] = useState(() => loadState('crab_platforms_v23', INITIAL_BOOKING_PLATFORMS));
      const [budgetSettings, setBudgetSettings] = useState(() => loadState('crab_budget_v23', { 
          totalTWD: 50000, 
          startDate: '2026-02-02',
          rates: { JPY_TWD: 0.215, USD_TWD: 31.5, KRW_TWD: 0.024, EUR_TWD: 34.2, TWD_TWD: 1 } 
      }));
      // V26 New States
      const [memoContent, setMemoContent] = useState(() => loadState('crab_memo_v24', ''));
      const [accommodations, setAccommodations] = useState(() => loadState('crab_accomm_v26', []));
      const [reservations, setReservations] = useState(() => loadState('crab_reserv_v26', []));
      // V30 Gourmet State
      const [gourmetList, setGourmetList] = useState(() => loadState('crab_gourmet_v30', []));

      // UI States
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showBatchModal, setShowBatchModal] = useState(false);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [showPlatformManager, setShowPlatformManager] = useState(false);
      const [showBooklet, setShowBooklet] = useState(false); 
      // V34 AI Modal States
      const [showAIModal, setShowAIModal] = useState(false);
      const [aiType, setAiType] = useState(null); // 'itinerary' or 'gourmet'
      const [aiInput1, setAiInput1] = useState(''); // Location / City
      const [aiInput2, setAiInput2] = useState(''); // Style / Food
      const [isGenerating, setIsGenerating] = useState(false);

      const [batchType, setBatchType] = useState(null); 
      const [batchText, setBatchText] = useState('');
      const [expenseFilter, setExpenseFilter] = useState('all');
      const [currentDayIndex, setCurrentDayIndex] = useState(0);
      const dayScrollRef = useRef(null);
      const [isScanning, setIsScanning] = useState(false);
      const [scanType, setScanType] = useState(null); 
      const fileInputRef = useRef(null);
      const backupInputRef = useRef(null); 
      const [targetDayId, setTargetDayId] = useState(null); 
      const [newPackingItemText, setNewPackingItemText] = useState('');
      const [activePackingCategory, setActivePackingCategory] = useState(null);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [editingScheduleId, setEditingScheduleId] = useState(null);
      const [newPlatformName, setNewPlatformName] = useState('');
      
      // V26 Input States - Initialize with startDate if possible
      const [newHotel, setNewHotel] = useState({ name: '', address: '', note: '', date: budgetSettings.startDate || '' });
      const [newReserv, setNewReserv] = useState({ title: '', time: '', code: '' });
      const [showAddHotel, setShowAddHotel] = useState(false);
      const [showAddReserv, setShowAddReserv] = useState(false);
      // V30 Gourmet Input
      const [newGourmet, setNewGourmet] = useState({ name: '', city: 'å¤§é˜ª', location: '', photo: null, note: '' });
      const [showAddGourmet, setShowAddGourmet] = useState(false);

      // Persistence
      useEffect(() => { saveState('crab_itinerary_v23', itinerary); }, [itinerary]);
      useEffect(() => { saveState('crab_expenses_v23', expenses); }, [expenses]);
      useEffect(() => { saveState('crab_shopping_v23', shoppingList); }, [shoppingList]);
      useEffect(() => { saveState('crab_packing_v23', packingList); }, [packingList]);
      useEffect(() => { saveState('crab_packing_cats_v23', packingCategories); }, [packingCategories]);
      useEffect(() => { saveState('crab_methods_v23', paymentMethods); }, [paymentMethods]);
      useEffect(() => { saveState('crab_platforms_v23', bookingPlatforms); }, [bookingPlatforms]);
      useEffect(() => { saveState('crab_budget_v23', budgetSettings); }, [budgetSettings]);
      useEffect(() => { saveState('crab_memo_v24', memoContent); }, [memoContent]);
      useEffect(() => { saveState('crab_accomm_v26', accommodations); }, [accommodations]);
      useEffect(() => { saveState('crab_reserv_v26', reservations); }, [reservations]);
      useEffect(() => { saveState('crab_gourmet_v30', gourmetList); }, [gourmetList]);

      const [newExpense, setNewExpense] = useState({ date: itinerary[0]?.date || '', item: '', amount: '', currency: 'JPY', category: 'ðŸœ é£²é£Ÿ', method: paymentMethods[0], platform: bookingPlatforms[0], note: '' });
      const [newShopItem, setNewShopItem] = useState({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });

      const formatDate = (dateStr) => { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth()+1}/${d.getDate()}`; };
      const getWeekday = (dateStr) => { const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­']; return days[new Date(dateStr).getDay()]; };

      const updateItineraryDates = () => {
          if (!budgetSettings.startDate) return;
          const start = new Date(budgetSettings.startDate);
          const newItinerary = itinerary.map((item, index) => {
              const d = new Date(start); d.setDate(start.getDate() + index);
              return { ...item, date: d.toISOString().split('T')[0], weekday: getWeekday(d.toISOString().split('T')[0]) };
          });
          setItinerary(newItinerary); alert('è¡Œç¨‹æ—¥æœŸå·²å…¨éƒ¨æ›´æ–°ï¼');
      };

      const getExchangeRate = (currencyCode) => { return budgetSettings?.rates?.[`${currencyCode}_TWD`] || 1; };

      const getDailyTotal = (date) => {
        const dailyExpenses = expenses.filter(e => e.date === date);
        const totalTWD = dailyExpenses.reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);
        return totalTWD;
      };

      const openGoogleMaps = (e, content) => { 
          e.stopPropagation(); 
          if(!content) return;
          window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content)}`, '_blank'); 
      };

      const scrollToDay = (index) => { if (dayScrollRef.current) { const width = dayScrollRef.current.offsetWidth; dayScrollRef.current.scrollTo({ left: width * index, behavior: 'smooth' }); setCurrentDayIndex(index); }};

      const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > 800) { height = Math.round((height * 800) / width); width = 800; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }; img.src = event.target.result;
            }; reader.readAsDataURL(file);
        });
      };

      // --- V33 OCR Logic Update ---
      const handleFileSelect = async (e) => {
        const file = e.target.files[0]; if (!file) return; setIsScanning(true);
        try {
            if (scanType === 'photo' && targetDayId) {
                const base64 = await compressImage(file);
                updateItinerary(targetDayId, 'photo', base64); alert('ç…§ç‰‡å·²å„²å­˜ï¼');
            } else if (scanType === 'gourmetPhoto' && targetDayId) {
                 const base64 = await compressImage(file);
                 if (targetDayId === 'new') { setNewGourmet(prev => ({ ...prev, photo: base64 })); } 
                 else { setGourmetList(gourmetList.map(g => g.id === targetDayId ? { ...g, photo: base64 } : g)); }
                 alert('ç¾Žé£Ÿç…§ç‰‡å·²æº–å‚™ï¼');
            } else {
                if (typeof Tesseract === 'undefined') { alert('è¾¨è­˜åŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦'); return; }
                const { data: { text } } = await Tesseract.recognize(file, 'eng+jpn+chi_tra');
                
                if (scanType === 'receipt') {
                    const numbers = text.match(/\d{1,3}(,\d{3})*(\.\d+)?/g) || [];
                    const cleanNumbers = numbers.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => n > 100); 
                    const maxAmount = cleanNumbers.length > 0 ? Math.max(...cleanNumbers) : '';
                    let guessedCategory = 'ðŸœ é£²é£Ÿ';
                    const lowerText = text.toLowerCase();
                    if (lowerText.includes('uniqlo') || lowerText.includes('donki') || lowerText.includes('shop')) guessedCategory = 'ðŸ›ï¸ è³¼ç‰©';
                    else if (lowerText.includes('bus') || lowerText.includes('train') || lowerText.includes('taxi')) guessedCategory = 'ðŸšƒ äº¤é€š';
                    else if (lowerText.includes('hotel') || lowerText.includes('inn')) guessedCategory = 'ðŸ¨ ä½å®¿';
                    setNewExpense(prev => ({ ...prev, amount: maxAmount || prev.amount, category: guessedCategory, note: 'OCRè‡ªå‹•è¾¨è­˜' }));
                    alert(`æ”¶æ“šè¾¨è­˜å®Œæˆï¼é‡‘é¡: ${maxAmount}`);
                } 
                // V33 New OCR Import Logic
                else if (scanType === 'itineraryImport' && targetDayId) {
                    const lines = text.split('\n');
                    const newItems = [];
                    lines.forEach(line => {
                        // Regex for time like 09:00, 9:00, 0900 or 14:30
                        const timeMatch = line.match(/(\d{1,2}[:ï¼š]\d{2})/);
                        if (timeMatch) {
                            const time = timeMatch[1].replace('ï¼š', ':');
                            // Remove time from string to get activity
                            const activity = line.replace(timeMatch[0], '').trim();
                            if(activity && activity.length > 1) { // Filter out noise
                                newItems.push({
                                    id: Date.now() + Math.random(),
                                    time: time.padStart(5, '0'), // Ensure 09:00 format
                                    category: 'æ™¯é»ž', // Default
                                    activity: activity,
                                    note: 'OCR åŒ¯å…¥'
                                });
                            }
                        }
                    });
                    
                    if(newItems.length > 0) {
                         const updatedItinerary = itinerary.map(day => {
                             if(day.id === targetDayId) {
                                 const mergedSchedule = [...(day.schedule || []), ...newItems].sort((a,b) => a.time.localeCompare(b.time));
                                 return { ...day, schedule: mergedSchedule };
                             }
                             return day;
                         });
                         setItinerary(updatedItinerary);
                         alert(`æˆåŠŸè¾¨è­˜ä¸¦åŒ¯å…¥ ${newItems.length} å€‹è¡Œç¨‹é …ç›®ï¼`);
                    } else {
                        alert('æœªèƒ½è¾¨è­˜å‡ºæ™‚é–“æ ¼å¼ (å¦‚ 14:00)ï¼Œè«‹ç¢ºèªç…§ç‰‡æ¸…æ™°åº¦');
                    }
                }
            }
        } catch (error) { console.error(error); alert('è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦'); } 
        finally { setIsScanning(false); if(fileInputRef.current) fileInputRef.current.value = ''; setScanType(null); setTargetDayId(null); }
      };

      // V34 AI Handlers
      const openAIPlanner = (dayId) => {
          setAiType('itinerary');
          setTargetDayId(dayId);
          setAiInput1('å¤§é˜ª');
          setAiInput2('æ”¾é¬†ã€é€›è¡—');
          setShowAIModal(true);
      };

      const openAIGourmet = () => {
          setAiType('gourmet');
          setAiInput1('å¤§é˜ª');
          setAiInput2('æ‹‰éºµ');
          setShowAIModal(true);
      };

      const handleAIGenerate = async () => {
          if (!aiInput1 || !aiInput2) { alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'); return; }
          setIsGenerating(true);
          try {
              if (aiType === 'itinerary') {
                  const day = itinerary.find(d => d.id === targetDayId);
                  const prompt = `You are a travel guide. Plan a one-day itinerary for ${day?.date} in ${aiInput1} with style: ${aiInput2}. 
                  Return strictly a JSON array of objects (no markdown, no extra text) with keys:
                  "time" (HH:MM format, 24h), "category" (Must be one of: æ™¯é»ž, åƒé£¯, é€›è¡—, äº¤é€š, ä½å®¿, å½ˆæ€§), "activity" (Short concise name), "note" (Reason or tip, max 20 chars).
                  Start from 09:00 to 20:00. Give about 5-8 items.`;
                  
                  const resultText = await callGeminiAPI(prompt);
                  const cleanJson = resultText.replace(/```json|```/g, '').trim();
                  const newItems = JSON.parse(cleanJson);
                  
                  if(Array.isArray(newItems)) {
                      const formattedItems = newItems.map(item => ({ ...item, id: Date.now() + Math.random() }));
                      const updatedItinerary = itinerary.map(d => {
                          if (d.id === targetDayId) {
                              return { ...d, schedule: [...(d.schedule || []), ...formattedItems].sort((a,b) => a.time.localeCompare(b.time)) };
                          } return d;
                      });
                      setItinerary(updatedItinerary);
                      alert('è¡Œç¨‹è¦åŠƒå®Œæˆï¼å·²åŠ å…¥æ™‚é–“è¡¨ã€‚');
                      setShowAIModal(false);
                  } else throw new Error("Format error");

              } else if (aiType === 'gourmet') {
                  const prompt = `Recommend 3-5 restaurants in ${aiInput1} serving ${aiInput2}.
                  Return strictly a JSON array of objects (no markdown) with keys:
                  "name" (Restaurant Name), "location" (Area/Address for Google Maps), "note" (Why it's good, max 20 chars).`;
                  
                  const resultText = await callGeminiAPI(prompt);
                  const cleanJson = resultText.replace(/```json|```/g, '').trim();
                  const newItems = JSON.parse(cleanJson);

                  if(Array.isArray(newItems)) {
                      const formattedItems = newItems.map(item => ({ ...item, id: Date.now() + Math.random(), city: aiInput1, photo: null }));
                      setGourmetList([...gourmetList, ...formattedItems]);
                      alert('ç¾Žé£ŸæŽ¨è–¦å·²åŠ å…¥æ¸…å–®ï¼');
                      setShowAIModal(false);
                  } else throw new Error("Format error");
              }
          } catch(e) {
              console.error(e);
              alert('AI ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
              setIsGenerating(false);
          }
      };

      const triggerFileAction = (type, id = null) => { setScanType(type); setTargetDayId(id); fileInputRef.current.click(); };

      const addDay = () => {
        const newId = Date.now(); let nextDate = new Date();
        if (itinerary.length > 0) { const lastDate = new Date(itinerary[itinerary.length - 1].date); lastDate.setDate(lastDate.getDate() + 1); nextDate = lastDate; } 
        else if (budgetSettings.startDate) { nextDate = new Date(budgetSettings.startDate); }
        const dateStr = nextDate.toISOString().split('T')[0];
        const newDay = { id: newId, date: dateStr, weekday: getWeekday(dateStr), content: '', transport: '', stay: '', food: '', highlights: '', photo: null, schedule: [] };
        setItinerary([...itinerary, newDay]); setTimeout(() => scrollToDay(itinerary.length), 100);
      };
      const removeDay = (id) => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä¸€å¤©å—Žï¼Ÿ')) setItinerary(itinerary.filter(d => d.id !== id)); };
      const updateItinerary = (id, field, value) => { setItinerary(itinerary.map(item => item.id === id ? { ...item, [field]: value } : item)); };

      const addScheduleItem = (dayId) => {
          const newScheduleItem = { id: Date.now(), time: '09:00', category: 'æ™¯é»ž', activity: '', note: '' };
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) { return { ...day, schedule: [...(day.schedule || []), newScheduleItem] }; }
              return day;
          }); setItinerary(updatedItinerary);
      };
      const updateScheduleItem = (dayId, itemId, field, value) => {
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) {
                  const updatedSchedule = day.schedule.map(item => item.id === itemId ? { ...item, [field]: value } : item);
                  return { ...day, schedule: updatedSchedule };
              } return day;
          }); setItinerary(updatedItinerary);
      };
      const removeScheduleItem = (dayId, itemId) => {
          if(!confirm('åˆªé™¤æ­¤è¡Œç¨‹ç¯€é»žï¼Ÿ')) return;
          const updatedItinerary = itinerary.map(day => {
              if (day.id === dayId) { return { ...day, schedule: day.schedule.filter(item => item.id !== itemId) }; }
              return day;
          }); setItinerary(updatedItinerary);
      };
      const handleScheduleLongPress = (id) => { setEditingScheduleId(id); };
      const moveScheduleItem = (dayId, itemId, direction) => {
          const dayIndex = itinerary.findIndex(d => d.id === dayId);
          if (dayIndex === -1) return;
          const day = itinerary[dayIndex];
          const itemIndex = day.schedule.findIndex(i => i.id === itemId);
          if (itemIndex === -1) return;
          const newSchedule = [...day.schedule];
          if (direction === 'up' && itemIndex > 0) { [newSchedule[itemIndex], newSchedule[itemIndex - 1]] = [newSchedule[itemIndex - 1], newSchedule[itemIndex]]; } 
          else if (direction === 'down' && itemIndex < newSchedule.length - 1) { [newSchedule[itemIndex], newSchedule[itemIndex + 1]] = [newSchedule[itemIndex + 1], newSchedule[itemIndex]]; }
          const newItinerary = [...itinerary]; newItinerary[dayIndex] = { ...day, schedule: newSchedule }; setItinerary(newItinerary);
      };

      const linkScheduleToExpense = (dayId, itemId) => {
          const day = itinerary.find(d => d.id === dayId);
          const item = day.schedule.find(i => i.id === itemId);
          if (item.expenseId) {
              if (confirm(`æ­¤è¡Œç¨‹å·²é€£çµä¸€ç­†å¸³ç›®ï¼Œè¦åˆªé™¤è©²ç­†å¸³ç›®å—Žï¼Ÿ`)) {
                  setExpenses(expenses.filter(e => e.id !== item.expenseId));
                  updateScheduleItem(dayId, itemId, 'expenseId', null);
              }
              return;
          }
          const amountStr = prompt(`è«‹è¼¸å…¥ã€Œ${item.activity}ã€çš„èŠ±è²»é‡‘é¡ (JPY):`, "0");
          if (amountStr === null) return; 
          const amount = parseFloat(amountStr);
          if (isNaN(amount)) return;
          const newExpId = Date.now();
          const newExpenseObj = { id: newExpId, date: day.date, item: item.activity, amount: amount, currency: 'JPY', category: item.category || 'ðŸœ é£²é£Ÿ', method: paymentMethods[0], note: `[è¡Œç¨‹é€£å‹•] ${item.note || ''}` };
          setExpenses([...expenses, newExpenseObj]);
          updateScheduleItem(dayId, itemId, 'expenseId', newExpId); 
          alert('å·²åŒæ­¥è‡³è¨˜å¸³é é¢ï¼');
      };

      const handleDirectAddExpense = () => {
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]);
        setNewExpense({ ...newExpense, item: '', amount: '' }); 
      };
      const handleAddExpense = () => { 
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]);
        setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
        setShowExpenseModal(false);
      };

      const handleDeleteExpense = (id) => { 
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—Žï¼Ÿ')) {
            setExpenses(expenses.filter(e => e.id !== id));
            const linkedShopItem = shoppingList.find(s => s.expenseId === id);
            if(linkedShopItem) {
                setShoppingList(shoppingList.map(s => s.id === linkedShopItem.id ? { ...s, bought: false, expenseId: null } : s));
            }
            const newItinerary = itinerary.map(day => ({
                ...day,
                schedule: day.schedule.map(s => s.expenseId === id ? { ...s, expenseId: null } : s)
            }));
            setItinerary(newItinerary);
        }
      };

      const handleAddShoppingItem = () => {
        if (!newShopItem.item) return;
        setShoppingList([...shoppingList, { id: Date.now(), ...newShopItem, budget: parseFloat(newShopItem.budget) || 0, splitCount: parseInt(newShopItem.splitCount) || 1, bought: false }]);
        setNewShopItem({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });
      };

      const toggleShoppingItem = (id) => {
          const item = shoppingList.find(i => i.id === id);
          if (!item) return;
          const isBuying = !item.bought; 
          let newExpenseId = item.expenseId;
          let updatedExpenses = [...expenses];
          if (isBuying) {
              const today = new Date().toISOString().split('T')[0];
              const defaultDate = (today >= budgetSettings.startDate) ? today : budgetSettings.startDate;
              newExpenseId = Date.now(); 
              updatedExpenses.push({ id: newExpenseId, date: defaultDate, item: item.item, amount: item.budget, currency: 'JPY', category: 'ðŸ›ï¸ è³¼ç‰©', method: paymentMethods[0], note: `[æˆ°åˆ©å“é€£å‹•] ${item.type === 'agent' ? 'ä»£è³¼: '+item.note : ''}` });
              alert(`å·²è‡ªå‹•åŠ å…¥è¨˜å¸³ï¼š\n${item.item} Â¥${item.budget}\n(å¯å†åŽ»è¨˜å¸³é é¢ä¿®æ­£é‡‘é¡)`);
          } else {
              if (newExpenseId) { updatedExpenses = updatedExpenses.filter(e => e.id !== newExpenseId); newExpenseId = null; }
          }
          setExpenses(updatedExpenses);
          setShoppingList(shoppingList.map(i => i.id === id ? { ...i, bought: isBuying, expenseId: newExpenseId } : i));
      };

      const deleteShoppingItem = (id) => { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setShoppingList(shoppingList.filter(i => i.id !== id)); };

      const togglePackingItem = (id) => setPackingList(packingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      const addPackingItemToCategory = (category) => {
          if(!newPackingItemText) return;
          setPackingList([...packingList, { id: Date.now(), category: category, item: newPackingItemText, checked: false }]);
          setNewPackingItemText(''); setActivePackingCategory(null);
      };
      const deletePackingItem = (id) => setPackingList(packingList.filter(i => i.id !== id));
      const addPackingCategory = () => { if(newCategoryName && !packingCategories.includes(newCategoryName)) { setPackingCategories([...packingCategories, newCategoryName]); setNewCategoryName(''); }};
      const deletePackingCategory = (category) => { if(confirm(`ç¢ºå®šåˆªé™¤ã€Œ${category}ã€ï¼Ÿ`)) { setPackingCategories(packingCategories.filter(c => c !== category)); setPackingList(packingList.filter(item => item.category !== category)); }};

      const addBookingPlatform = () => { if (newPlatformName && !bookingPlatforms.includes(newPlatformName)) { setBookingPlatforms([...bookingPlatforms, newPlatformName]); setNewPlatformName(''); } };
      const deleteBookingPlatform = (p) => { if(confirm(`ç¢ºå®šåˆªé™¤å¹³å°ã€Œ${p}ã€ï¼Ÿ`)) setBookingPlatforms(bookingPlatforms.filter(item => item !== p)); };

      const handleBatchImport = () => {
          if (!batchText) return;
          const items = batchText.split('\n').filter(line => line.trim() !== '');
          if (batchType === 'shopping') {
              const newItems = items.map(line => ({ id: Date.now() + Math.random(), item: line.trim(), budget: 0, store: '', priority: 'medium', type: 'self', note: '', splitCount: 1, bought: false }));
              setShoppingList([...shoppingList, ...newItems]);
          } else if (batchType === 'packing') {
              const newItems = items.map(line => ({ id: Date.now() + Math.random(), category: 'ðŸ“ è‡ªè¨‚', item: line.trim(), checked: false }));
              setPackingList([...packingList, ...newItems]);
          }
          setBatchText(''); setShowBatchModal(false); alert(`å·²åŒ¯å…¥ ${items.length} å€‹é …ç›®ï¼`);
      };

      const fetchExchangeRate = async () => {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            if(data?.rates?.TWD) {
                setBudgetSettings({ ...budgetSettings, exchangeRate: data.rates.TWD });
                alert(`åŒ¯çŽ‡å·²æ›´æ–°ç‚º: ${data.rates.TWD}`);
            }
        } catch(e) { alert('ç„¡æ³•æŠ“å–åŒ¯çŽ‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥'); }
      };

      const addMethod = (m) => { if(m && !paymentMethods.includes(m)) setPaymentMethods([...paymentMethods, m]); };
      const removeMethod = (m) => setPaymentMethods(paymentMethods.filter(i => i !== m));

      const totalSpentConvertedTWD = expenses.reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);
      const remainingBudget = budgetSettings.totalTWD - totalSpentConvertedTWD;

      const shoppingStats = shoppingList.reduce((acc, item) => {
        if (item.type === 'agent') { acc.agentCount++; acc.agentTotal += item.budget; }
        else if (item.type === 'split') { acc.splitCount++; acc.splitTotal += item.budget; }
        else { acc.selfCount++; acc.selfTotal += item.budget; }
        return acc;
      }, { agentTotal: 0, agentCount: 0, selfTotal: 0, selfCount: 0, splitTotal: 0, splitCount: 0 });

      const agentSummary = shoppingList
        .filter(item => item.type === 'agent' && item.note)
        .reduce((acc, item) => {
            const name = item.note.trim();
            if (!acc[name]) acc[name] = { jpy: 0, twd: 0 };
            acc[name].jpy += item.budget;
            acc[name].twd += Math.round(item.budget * getExchangeRate('JPY'));
            return acc;
        }, {});
      
      const handleAddHotel = () => {
        if(!newHotel.name || !newHotel.date) { alert('è«‹å¡«å¯«æ—¥æœŸå’Œé£¯åº—åç¨±'); return; }
        setAccommodations([...accommodations, { id: Date.now(), ...newHotel }]);
        setNewHotel({ name: '', address: '', note: '', date: budgetSettings.startDate || '' });
        setShowAddHotel(false);
      };
      const handleDeleteHotel = (id) => { if(confirm('åˆªé™¤æ­¤ä½å®¿ï¼Ÿ')) setAccommodations(accommodations.filter(h => h.id !== id)); };

      const handleAddReserv = () => {
        if(!newReserv.title) return;
        setReservations([...reservations, { id: Date.now(), ...newReserv }]);
        setNewReserv({ title: '', time: '', code: '' });
        setShowAddReserv(false);
      };
      const handleDeleteReserv = (id) => { if(confirm('åˆªé™¤æ­¤é ç´„ï¼Ÿ')) setReservations(reservations.filter(r => r.id !== id)); };

      const handleAddGourmet = () => {
          if(!newGourmet.name) return;
          setGourmetList([...gourmetList, { id: Date.now(), ...newGourmet }]);
          setNewGourmet({ name: '', city: 'å¤§é˜ª', location: '', photo: null, note: '' });
          setShowAddGourmet(false);
      };
      const handleDeleteGourmet = (id) => { if(confirm('åˆªé™¤æ­¤ç¾Žé£Ÿæƒ…å ±ï¼Ÿ')) setGourmetList(gourmetList.filter(g => g.id !== id)); };

      const handleBackup = () => {
          const data = { itinerary, expenses, shoppingList, packingList, packingCategories, paymentMethods, bookingPlatforms, budgetSettings, memoContent, accommodations, reservations, gourmetList };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `2026é—œè¥¿ä¹‹æ—…_å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
      };

      const handleRestore = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
              try {
                  const data = JSON.parse(event.target.result);
                  if (confirm('ç¢ºå®šè¦é‚„åŽŸå‚™ä»½å—Žï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) {
                      if (data.itinerary) setItinerary(data.itinerary);
                      if (data.expenses) setExpenses(data.expenses);
                      if (data.shoppingList) setShoppingList(data.shoppingList);
                      if (data.packingList) setPackingList(data.packingList);
                      if (data.packingCategories) setPackingCategories(data.packingCategories);
                      if (data.paymentMethods) setPaymentMethods(data.paymentMethods);
                      if (data.bookingPlatforms) setBookingPlatforms(data.bookingPlatforms);
                      if (data.budgetSettings) setBudgetSettings(data.budgetSettings);
                      if (data.memoContent) setMemoContent(data.memoContent);
                      if (data.accommodations) setAccommodations(data.accommodations);
                      if (data.reservations) setReservations(data.reservations);
                      if (data.gourmetList) setGourmetList(data.gourmetList);
                      alert('è³‡æ–™é‚„åŽŸæˆåŠŸï¼');
                      setShowSettingsModal(false);
                  }
              } catch (err) { console.error(err); alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•é‚„åŽŸ'); }
          }; reader.readAsText(file); if (backupInputRef.current) backupInputRef.current.value = '';
      };

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        const itineraryData = [];
        itinerary.forEach(d => {
            if (d.schedule && d.schedule.length > 0) { d.schedule.forEach(s => itineraryData.push({ 'æ—¥æœŸ': d.date, 'æ˜ŸæœŸ': d.weekday, 'æ™‚é–“': s.time, 'é¡žåˆ¥': s.category, 'è¡Œç¨‹': s.activity, 'å‚™è¨»': s.note })); } 
            else { itineraryData.push({ 'æ—¥æœŸ': d.date, 'æ˜ŸæœŸ': d.weekday, 'æ™‚é–“': '', 'é¡žåˆ¥': 'å…¨æ—¥', 'è¡Œç¨‹': d.content || 'æœªè¦åŠƒ', 'å‚™è¨»': '' }); }
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(shoppingList.map(s => ({ 'é¡žåˆ¥': s.priority, 'é …ç›®': s.item, 'æ—¥å¹£': s.budget, 'ç‹€æ…‹': s.bought ? 'å·²è²·' : 'æœªè²·' }))), 'æˆ°åˆ©å“');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses.map(e => ({ 'æ—¥æœŸ': e.date, 'é …ç›®': e.item, 'é‡‘é¡': e.amount, 'å¹£åˆ¥': e.currency }))), 'è¨˜å¸³');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(itineraryData), 'è¡Œç¨‹æ‰‹å†Š');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(packingList.map(p => ({ 'é …ç›®': p.item, 'å·²å¸¶': p.checked ? 'V' : '' }))), 'è¡ŒæŽ');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(accommodations.map(a => ({'æ—¥æœŸ': a.date, 'é£¯åº—': a.name, 'åœ°å€': a.address, 'è¨‚å–®/å‚™è¨»': a.note}))), 'ä½å®¿');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(reservations.map(r => ({'é …ç›®': r.title, 'æ™‚é–“': r.time, 'ä»£è™Ÿ/å‚™è¨»': r.code}))), 'é ç´„');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(gourmetList.map(g => ({'åº—å': g.name, 'åŸŽå¸‚': g.city, 'åœ°é»ž': g.location, 'å‚™è¨»': g.note}))), 'ç¾Žé£Ÿç‰¹æœ');
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([{å‚™å¿˜éŒ„: memoContent}]), 'å‚™å¿˜éŒ„');
        XLSX.writeFile(wb, `é—œè¥¿èžƒèŸ¹ä¹‹æ—…_å®Œæ•´å ±è¡¨.xlsx`);
        setShowSettingsModal(false);
      };

      // V31 Booklet Component
      const TravelBooklet = () => {
        return (
            <div id="booklet-root" className="fixed inset-0 bg-white z-[9999] overflow-auto text-black">
                {/* Close Button (Hidden when printing) */}
                <div className="fixed top-4 right-4 z-50 flex gap-2 print-hidden">
                    <button onClick={() => window.print()} className="bg-[#FF6B6B] text-white px-4 py-2 rounded-xl font-bold shadow-lg hover:bg-red-500 flex items-center gap-2"><Icons.Printer/> åˆ—å° / å­˜PDF</button>
                    <button onClick={() => setShowBooklet(false)} className="bg-gray-800 text-white px-4 py-2 rounded-xl font-bold shadow-lg">é—œé–‰</button>
                </div>

                {/* --- COVER PAGE --- */}
                <div className="booklet-page flex flex-col items-center justify-center border-b-2 border-dashed border-gray-300 page-break">
                    <div className="text-4xl mb-4">ðŸ¦€</div>
                    <h1 className="text-6xl font-black mb-2 text-[#FF6B6B] tracking-widest text-center">2026<br/>å¤§é—œè¥¿æ•£ç­–</h1>
                    <div className="w-20 h-1 bg-black mb-8"></div>
                    <div className="text-2xl font-bold text-gray-600 mb-8">{budgetSettings.startDate} å‡ºç™¼</div>
                    {itinerary[0]?.photo && (
                        <div className="w-64 h-64 rounded-full overflow-hidden border-8 border-[#E0F7FA] shadow-xl mb-8">
                            <img src={itinerary[0].photo} className="w-full h-full object-cover"/>
                        </div>
                    )}
                    <div className="mt-auto mb-10 text-center">
                        <div className="text-sm text-gray-400 font-bold mb-2">TRAVEL GUIDE BOOK</div>
                        <div className="text-xl font-bold border-2 border-black px-4 py-1 rounded-lg">æ—…äººæ‰‹å†Š</div>
                    </div>
                </div>

                {/* --- OVERVIEW PAGE --- */}
                <div className="booklet-page page-break">
                    <h2 className="text-3xl font-black border-b-4 border-[#FF6B6B] pb-2 mb-6">âœˆï¸ æ—…ç¨‹ç¸½è¦½</h2>
                    
                    <div className="mb-8">
                        <h3 className="text-xl font-bold mb-3 bg-gray-100 p-2 rounded">ðŸ“… ä½å®¿å®‰æŽ’</h3>
                        <table className="w-full text-sm border-collapse">
                            <thead><tr className="bg-gray-200 text-left"><th className="p-2">æ—¥æœŸ</th><th className="p-2">é£¯åº—</th><th className="p-2">å‚™è¨»</th></tr></thead>
                            <tbody>
                                {accommodations.sort((a,b) => new Date(a.date) - new Date(b.date)).map(h => (
                                    <tr key={h.id} className="border-b">
                                        <td className="p-2 font-bold">{h.date}</td>
                                        <td className="p-2">{h.name}<br/><span className="text-xs text-gray-500">{h.address}</span></td>
                                        <td className="p-2">{h.note}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="mb-8">
                        <h3 className="text-xl font-bold mb-3 bg-gray-100 p-2 rounded">ðŸŽ« é ç´„ç¥¨åˆ¸</h3>
                        <div className="grid grid-cols-2 gap-4">
                            {reservations.sort((a,b) => new Date(a.time) - new Date(b.time)).map(r => (
                                <div key={r.id} className="border p-2 rounded">
                                    <div className="text-xs text-gray-500">{new Date(r.time).toLocaleString()}</div>
                                    <div className="font-bold">{r.title}</div>
                                    <div className="text-sm font-mono mt-1">{r.code}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="mb-8">
                         <h3 className="text-xl font-bold mb-3 bg-gray-100 p-2 rounded">ðŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
                         <div className="flex justify-around text-center">
                             <div><div className="font-bold text-2xl">110</div><div className="text-xs">å ±è­¦</div></div>
                             <div><div className="font-bold text-2xl">119</div><div className="text-xs">æ•‘è­·</div></div>
                             <div><div className="font-bold text-xl">+81-90-8794-4568</div><div className="text-xs">å¤§é˜ªè¾¦äº‹è™•</div></div>
                         </div>
                    </div>
                    
                    {memoContent && (
                        <div className="border-2 border-dashed border-gray-300 p-4 rounded-xl min-h-[100px]">
                            <h3 className="text-lg font-bold mb-2">ðŸ“ å‚™å¿˜éŒ„</h3>
                            <pre className="whitespace-pre-wrap font-sans text-sm">{memoContent}</pre>
                        </div>
                    )}
                </div>

                {/* --- DAILY ITINERARY PAGES --- */}
                <div className="booklet-page page-break">
                     <h2 className="text-3xl font-black border-b-4 border-[#4ECDC4] pb-2 mb-6">ðŸ—ºï¸ è©³ç´°è¡Œç¨‹</h2>
                     <div className="space-y-8">
                        {itinerary.map((day) => (
                            <div key={day.id} className="avoid-break mb-8 border-l-4 border-gray-200 pl-4">
                                <div className="flex items-center gap-3 mb-4 bg-gray-50 p-2 rounded-r-xl">
                                    <div className="text-2xl font-black text-[#FF6B6B]">{day.date}</div>
                                    <div className="text-xl font-bold text-gray-400">({day.weekday})</div>
                                    <div className="text-sm ml-auto font-bold text-gray-500">{day.transport} / {day.stay}</div>
                                </div>
                                <div className="space-y-2">
                                    {day.schedule.map(s => (
                                        <div key={s.id} className="flex gap-4 items-start">
                                            <div className="w-12 text-right font-bold text-gray-600 pt-1">{s.time}</div>
                                            <div className="flex-1 border-b border-dashed border-gray-200 pb-2">
                                                <div className="font-bold text-lg flex items-center gap-2">
                                                    <span className="text-xs px-1 rounded text-white" style={{backgroundColor: SCHEDULE_CATEGORIES.find(c=>c.name===s.category)?.color || '#999'}}>{s.category}</span>
                                                    {s.activity}
                                                </div>
                                                {s.note && <div className="text-sm text-gray-500">{s.note}</div>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {day.photo && <img src={day.photo} className="h-32 object-cover rounded-xl mt-4 border border-gray-200"/>}
                            </div>
                        ))}
                     </div>
                </div>

                {/* --- GOURMET & SHOPPING PAGE --- */}
                <div className="booklet-page page-break">
                    <h2 className="text-3xl font-black border-b-4 border-[#FFA502] pb-2 mb-6">ðŸ½ï¸ ç¾Žé£Ÿ & ðŸ›ï¸ è³¼ç‰©</h2>
                    
                    {/* Gourmet Grid */}
                    <h3 className="text-xl font-bold mb-3">ðŸ˜‹ å¿…åƒæ¸…å–®</h3>
                    <div className="grid grid-cols-3 gap-4 mb-8">
                        {gourmetList.map(g => (
                            <div key={g.id} className="border rounded-lg overflow-hidden avoid-break">
                                <div className="h-24 bg-gray-100">
                                    {g.photo ? <img src={g.photo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300">No Photo</div>}
                                </div>
                                <div className="p-2">
                                    <div className="font-bold text-sm">{g.name}</div>
                                    <div className="text-xs text-gray-500">{g.city}</div>
                                    <div className="text-[10px] text-gray-400 mt-1">{g.note}</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Shopping Checklist */}
                    <h3 className="text-xl font-bold mb-3">ðŸŽ å¿…è²·æ¸…å–®</h3>
                    <div className="columns-2 gap-4">
                        {shoppingList.filter(i => i.priority === 'high' || i.priority === 'medium').map(s => (
                            <div key={s.id} className="flex items-center gap-2 mb-2 avoid-break text-sm">
                                <div className="w-4 h-4 border-2 border-black rounded"></div>
                                <div>
                                    <span className="font-bold">{s.item}</span>
                                    {s.store && <span className="text-xs text-gray-500 ml-1">(@{s.store})</span>}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
      };

      const AIModal = () => (
          <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" onClick={() => setShowAIModal(false)}>
              <div className="bg-white w-11/12 max-w-sm rounded-3xl p-5 fade-in shadow-2xl border-4 border-[#FFD93D]" onClick={e => e.stopPropagation()}>
                  <h3 className="font-bold text-2xl text-gray-800 mb-3 text-center flex items-center justify-center gap-2">
                      <span className="text-3xl">âœ¨</span> 
                      {aiType === 'itinerary' ? 'AI æ™ºèƒ½è¡Œç¨‹è¦åŠƒ' : 'AI ç¾Žé£Ÿçµäºº'}
                  </h3>
                  
                  {isGenerating ? (
                      <div className="flex flex-col items-center py-8">
                          <Icons.Sparkles size={48} className="text-[#FFD93D] loading-spin mb-4"/>
                          <div className="text-lg font-bold text-gray-600 animate-pulse">Gemini æ­£åœ¨æ€è€ƒä¸­...</div>
                      </div>
                  ) : (
                      <div className="space-y-4">
                          <div>
                              <label className="text-sm font-bold text-gray-500 ml-1">ðŸ“ {aiType === 'itinerary' ? 'ä½ æƒ³åŽ»å“ªè£¡ï¼Ÿ' : 'åŸŽå¸‚ / åœ°å€'}</label>
                              <input value={aiInput1} onChange={e => setAiInput1(e.target.value)} placeholder={aiType === 'itinerary' ? "ä¾‹å¦‚: äº¬éƒ½æ¸…æ°´å¯ºå‘¨é‚Š" : "ä¾‹å¦‚: å¤§é˜ªé›£æ³¢"} className="w-full bg-gray-100 rounded-xl p-3 outline-none font-bold text-lg"/>
                          </div>
                          <div>
                              <label className="text-sm font-bold text-gray-500 ml-1">ðŸŽ¨ {aiType === 'itinerary' ? 'åå¥½é¢¨æ ¼' : 'æƒ³åƒä»€éº¼ï¼Ÿ'}</label>
                              <input value={aiInput2} onChange={e => setAiInput2(e.target.value)} placeholder={aiType === 'itinerary' ? "ä¾‹å¦‚: æ‚ é–’ã€å¤è¹Ÿã€åƒç”œé»ž" : "ä¾‹å¦‚: å£½å¸ã€æ‹‰éºµã€ç‡’è‚‰"} className="w-full bg-gray-100 rounded-xl p-3 outline-none font-bold text-lg"/>
                          </div>
                          <button onClick={handleAIGenerate} className="w-full sparkle-btn py-3 rounded-xl font-black text-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                              <Icons.Sparkles size={24}/> é–‹å§‹ç”Ÿæˆ
                          </button>
                      </div>
                  )}
              </div>
          </div>
      );

      const ExpenseModal = () => (
         <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExpenseModal(false)}>
            <div className="bg-white w-11/12 max-w-sm rounded-3xl p-5 fade-in" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">ðŸ’° è¨˜ä¸€ç­† ({newExpense.date})</h3>
                <div className="space-y-3">
                   <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="w-full bg-gray-100 rounded-xl p-3 outline-none font-bold">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                   <input placeholder="è²·äº†ä»€éº¼ï¼Ÿ" value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="w-full text-lg font-bold border-b-2 border-dashed border-gray-300 outline-none py-1" />
                   <div className="flex gap-2">
                       <input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="flex-1 bg-gray-100 rounded-xl p-3 font-bold text-xl outline-none" />
                       <select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})} className="bg-gray-100 rounded-xl p-1 font-bold">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.symbol}</option>)}</select>
                   </div>
                   <button onClick={handleAddExpense} className="w-full bg-[#FF9F43] text-white font-bold py-3 rounded-xl korean-3d-btn">ç¢ºå®šè¨˜å¸³</button>
                </div>
            </div>
         </div>
      );

      const SettingsModal = () => {
        const [tempMethod, setTempMethod] = useState('');
        const [tempPlatform, setTempPlatform] = useState('');
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowSettingsModal(false)}>
              <div className="bg-white w-11/12 max-w-md rounded-3xl p-6 fade-in shadow-2xl h-4/5 flex flex-col" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 className="font-bold text-2xl text-gray-800">âš™ï¸ è¨­å®š</h3>
                    <button onClick={() => setShowSettingsModal(false)}><Icons.X size={30}/></button>
                </div>
                
                {/* V31 Booklet Button */}
                <button onClick={() => { setShowBooklet(true); setShowSettingsModal(false); }} className="w-full bg-[#FF6B6B] text-white font-bold text-lg py-4 rounded-xl shadow-md flex items-center justify-center gap-2 mb-4 hover:bg-red-500 transition-colors shrink-0 korean-3d-btn border-2 border-black">
                    <Icons.Book size={24}/> ç”¢ç”Ÿæ—…éŠå°æœ¬æœ¬ (PDF)
                </button>

                {/* V24: Backup & Restore Area */}
                <div className="grid grid-cols-2 gap-3 mb-4">
                    <button onClick={handleBackup} className="bg-[#5C6BC0] text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center gap-2 hover:bg-[#3F51B5]"><Icons.Download size={20}/> å‚™ä»½ JSON</button>
                    <button onClick={() => backupInputRef.current.click()} className="bg-[#FFA726] text-white font-bold py-3 rounded-xl shadow-md flex items-center justify-center gap-2 hover:bg-[#FB8C00]"><Icons.Upload size={20}/> é‚„åŽŸè³‡æ–™</button>
                </div>
                <button onClick={exportToExcel} className="w-full bg-[#2E7D32] text-white font-bold text-lg py-3 rounded-xl shadow-md flex items-center justify-center gap-2 mb-4 hover:bg-[#1B5E20] transition-colors shrink-0"><Icons.FileSpreadsheet size={24}/> åŒ¯å‡º Excel å ±è¡¨</button>

                <div className="flex-1 overflow-y-auto space-y-6 no-scrollbar pb-10">
                    <div className="bg-[#E0F2F1] p-4 rounded-xl border-2 border-[#80CBC4]">
                        <h4 className="font-bold text-xl text-[#00695C] mb-3 flex items-center gap-2"><Icons.Calendar/> æ—…éŠæ—¥æœŸ</h4>
                        <div><label className="text-sm text-gray-600 font-bold ml-1">æ—…éŠé–‹å§‹æ—¥æœŸ</label><div className="flex gap-2"><input type="date" value={budgetSettings.startDate} onChange={e => setBudgetSettings({...budgetSettings, startDate: e.target.value})} className="w-full p-2 rounded-lg border-2 border-[#80CBC4] outline-none font-bold text-xl text-gray-800"/><button onClick={updateItineraryDates} className="bg-[#26A69A] text-white px-3 py-1 rounded-lg font-bold text-sm shrink-0">æ›´æ–°æ—¥æœŸ</button></div></div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å·¥å…· (å¢ž/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full"><input value={tempMethod} onChange={e => setTempMethod(e.target.value)} placeholder="æ–°å¢ž..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" /><button onClick={() => { addMethod(tempMethod); setTempMethod(''); }} className="bg-gray-800 text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button></div>
                        <div className="flex flex-wrap gap-2">{paymentMethods.map(m => (<div key={m} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{m} <button onClick={() => removeMethod(m)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div>
                        <h4 className="font-bold text-lg text-gray-600 mb-2">æ”¯ä»˜å¹³å° (å¢ž/åˆª)</h4>
                        <div className="flex gap-2 mb-2 w-full"><input value={tempPlatform} onChange={e => setTempPlatform(e.target.value)} placeholder="æ–°å¢žå¹³å°..." className="flex-1 bg-gray-100 rounded-lg px-3 py-2 outline-none min-w-0" /><button onClick={() => { addPlatform(tempPlatform); setTempPlatform(''); }} className="bg-[#4ECDC4] text-white px-4 rounded-lg font-bold shrink-0 flex items-center justify-center"><Icons.Plus size={20}/></button></div>
                        <div className="flex flex-wrap gap-2">{bookingPlatforms.map(p => (<div key={p} className="bg-gray-50 border px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">{p} <button onClick={() => removePlatform(p)} className="text-gray-400 hover:text-red-400"><Icons.X size={14}/></button></div>))}</div>
                    </div>
                    <div className="bg-[#FFF3E0] p-4 rounded-xl border-2 border-[#FFE0B2]">
                        <h4 className="font-bold text-xl text-[#F57C00] mb-3 flex items-center gap-2"><Icons.Coins/> åŒ¯çŽ‡è¨­å®š (å°å°å¹£)</h4>
                        <div className="space-y-3">
                            <div><label className="text-sm text-gray-600 font-bold ml-1">å°å¹£ç¸½é ç®—</label><div className="flex items-center bg-white rounded-lg px-2 border-2 border-[#FFE0B2]"><span className="text-gray-400 font-bold text-xl">$</span><input type="number" value={budgetSettings.totalTWD} onChange={e => setBudgetSettings({...budgetSettings, totalTWD: parseInt(e.target.value)||0})} className="w-full p-2 outline-none font-bold text-2xl text-gray-800"/></div></div>
                            <div className="flex gap-2 items-end">
                                <div className="flex-1">
                                    <label className="text-xs text-gray-500 font-bold">æ—¥å¹£åŒ¯çŽ‡ (JPY to TWD)</label>
                                    <input type="number" step="0.001" value={budgetSettings.rates.JPY_TWD} onChange={e => setBudgetSettings({...budgetSettings, rates: {...budgetSettings.rates, JPY_TWD: parseFloat(e.target.value)||0}})} className="w-full p-2 rounded-lg border-2 border-[#FFE0B2] outline-none font-bold text-lg text-gray-800"/>
                                </div>
                                <button onClick={fetchExchangeRate} className="bg-[#FF9F43] text-white px-3 py-2 rounded-lg font-bold h-fit shrink-0 mb-0.5"><Icons.Refresh size={20}/> æŠ“å–å³æ™‚</button>
                            </div>
                            <div className="grid grid-cols-2 gap-3 mt-2">
                                {CURRENCIES.filter(c => c.code !== 'TWD' && c.code !== 'JPY').map(c => (
                                    <div key={c.code}>
                                        <label className="text-xs text-gray-500 font-bold">{c.label}</label>
                                        <input type="number" step="0.001" value={budgetSettings.rates[`${c.code}_TWD`] || 0} onChange={e => setBudgetSettings({...budgetSettings, rates: {...budgetSettings.rates, [`${c.code}_TWD`]: parseFloat(e.target.value)||0}})} className="w-full p-2 rounded-lg border-2 border-[#FFE0B2] outline-none font-bold text-lg text-gray-800"/>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
              </div>
            </div>
        );
      };

      const BatchModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowBatchModal(false)}>
            <div className="bg-white w-11/12 max-w-sm rounded-2xl p-5 fade-in" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl text-gray-800 mb-3 text-center">ðŸ“‹ æ‰¹æ¬¡åŒ¯å…¥ {batchType === 'shopping' ? 'æˆ°åˆ©å“' : 'è¡ŒæŽ'}</h3>
                <textarea className="w-full h-40 bg-gray-50 border-2 border-gray-200 rounded-xl p-3 outline-none font-bold text-gray-700" placeholder="è²¼ä¸Šæ¸…å–®ï¼Œä¸€è¡Œä¸€é …..." value={batchText} onChange={e => setBatchText(e.target.value)}></textarea>
                <div className="flex gap-2 mt-4">
                    <button onClick={() => setShowBatchModal(false)} className="flex-1 py-3 text-gray-400 font-bold">å–æ¶ˆ</button>
                    <button onClick={handleBatchImport} className="flex-1 bg-[#4ECDC4] text-white py-3 rounded-xl font-bold korean-3d-btn">é–‹å§‹åŒ¯å…¥</button>
                </div>
            </div>
        </div>
      );

      const FloatingActionButton = () => (
          <button onClick={() => activeTab === 'itinerary' && currentDayIndex !== null ? addScheduleItem(itinerary[currentDayIndex]?.id) : addDay()} className="fixed bottom-24 right-6 z-40 w-14 h-14 bg-[#FF6B6B] text-white rounded-full shadow-lg flex items-center justify-center border-2 border-white hover:scale-110 active:scale-95 transition-transform"><Icons.Plus size={32} /></button>
      );

      const TabButton = ({ id, IconComp, label, bgColor, activeColor }) => (
        <button onClick={() => { setActiveTab(id); }} className={`flex flex-col items-center justify-center rounded-2xl py-1 transition-all duration-150 w-full h-full relative overflow-hidden group ${activeTab === id ? 'translate-y-1 shadow-none ring-2 ring-offset-1' : 'shadow-[0_4px_0_0_rgba(0,0,0,0.2)] hover:-translate-y-0.5 hover:shadow-[0_5px_0_0_rgba(0,0,0,0.2)]'}`} style={{ backgroundColor: activeTab === id ? activeColor : bgColor, color: activeTab === id ? '#fff' : '#555', borderColor: activeTab === id ? activeColor : 'transparent' }}>
          <IconComp size={24} className="mb-0.5 drop-shadow-sm z-10" />
          <span className="text-xs font-black z-10 drop-shadow-sm tracking-wide">{label}</span>
          {activeTab === id && <div className="absolute inset-0 bg-black/10 z-0"></div>}
        </button>
      );

      return (
        <div className="flex flex-col h-full bg-white w-full max-w-4xl mx-auto shadow-2xl overflow-hidden relative font-sans text-gray-900">
          
          {showBooklet && <TravelBooklet />}
          {showAIModal && <AIModal />}

          {isScanning && <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 text-white"><Icons.Loader size={60} className="loading-spin mb-4 text-[#FF6B6B]" /><div className="text-3xl font-bold animate-pulse">è™•ç†ä¸­...</div></div>}
          <input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
          {/* Hidden input for backup restore */}
          <input type="file" accept=".json" ref={backupInputRef} onChange={handleRestore} className="hidden" />

          {showSettingsModal && <SettingsModal />}
          {showExpenseModal && <ExpenseModal />}
          {showExportModal && <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExportModal(false)}><div className="bg-white w-11/12 max-w-sm rounded-2xl p-6 fade-in" onClick={e => e.stopPropagation()}><h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">ðŸ“Š åŒ¯å‡º Excel</h3><button onClick={exportToExcel} className="w-full bg-[#207245] text-white font-bold text-xl py-4 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2 mb-2"><Icons.FileSpreadsheet size={24} /> ä¸‹è¼‰å ±è¡¨</button><button onClick={() => setShowExportModal(false)} className="w-full text-gray-500 font-bold py-3 text-lg">å–æ¶ˆ</button></div></div>}
          {showBatchModal && <BatchModal />}

          <div className="safe-area-top"></div>

          {/* V21 Compact Header */}
          <div className="bg-[#FF6B6B] px-4 py-2 relative overflow-hidden border-b-2 border-black shrink-0 z-50">
            <div className="flex justify-between items-center">
              <h1 className="text-2xl font-bold text-white tracking-widest flex items-center gap-2"><span>ðŸ¦€</span> 2026å¤§é—œè¥¿æ•£ç­–</h1>
              <div className="flex items-center gap-3">
                  <WeatherWidget />
                  <button onClick={() => setShowSettingsModal(true)} className="text-white hover:text-gray-100 bg-white/20 p-1.5 rounded-full"><Icons.Settings size={24} /></button>
              </div>
            </div>
          </div>

          <div className="flex-1 overflow-hidden relative bg-[#E0F7FA]">
            {activeTab === 'itinerary' && (
              <div className="h-full flex flex-col p-4">
                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-3 shrink-0 py-1">
                  {itinerary.map((day, index) => (<button key={day.id} onClick={() => scrollToDay(index)} className={`shrink-0 w-12 h-12 rounded-full font-bold text-lg border-4 border-white shadow-md flex items-center justify-center transition-all ${currentDayIndex === index ? 'scale-110 ring-2 ring-black' : 'opacity-70'}`} style={{ backgroundColor: BUTTON_COLORS[index % BUTTON_COLORS.length], color: 'white' }}>{formatDate(day.date)}</button>))}
                  <button onClick={addDay} className="shrink-0 w-12 h-12 rounded-full bg-white border-4 border-dashed border-gray-400 flex items-center justify-center text-gray-400 hover:text-[#FF6B6B]"><Icons.Plus size={24}/></button>
                </div>
                <div ref={dayScrollRef} className="flex-1 flex overflow-x-auto snap-x-mandatory no-scrollbar gap-4 h-full" onScroll={(e) => { const index = Math.round(e.target.scrollLeft / e.target.offsetWidth); setCurrentDayIndex(index); }}>
                    {itinerary.map((day, index) => {
                        const dayTotal = getDailyTotal(day.date);
                        return (
                            <div key={day.id} className="w-full shrink-0 snap-center flex flex-col h-full">
                                <div className="bg-white border-4 border-black rounded-3xl shadow-xl flex flex-col relative h-full overflow-hidden">
                                    <div className="bg-gray-50 border-b-2 border-dashed border-gray-300 p-3 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-2"><span className="font-black text-3xl text-gray-800">{formatDate(day.date)}</span><span className="text-xl font-bold text-gray-400">({getWeekday(day.date)})</span></div>
                                        <div className="flex gap-2">
                                            {/* V34 AI Plan Button */}
                                            <button onClick={() => openAIPlanner(day.id)} className="p-2 sparkle-btn rounded-xl shadow active:translate-y-1 flex items-center gap-1 font-bold text-xs"><Icons.Sparkles size={16}/> AI è¦åŠƒ</button>
                                            
                                            <button onClick={() => triggerFileAction('itineraryImport', day.id)} className="p-2 bg-[#B2DFDB] text-[#00695C] rounded-xl border border-black shadow active:translate-y-1 flex items-center gap-1 font-bold text-xs"><Icons.ListPlus size={16}/> åŒ¯å…¥</button>
                                            <button onClick={() => triggerFileAction('itinerary', day.id)} className="p-2 bg-[#E1BEE7] text-[#9C27B0] rounded-xl border border-black shadow active:translate-y-1"><Icons.Camera size={18}/></button>
                                            <button onClick={() => removeDay(day.id)} className="p-2 bg-gray-100 text-gray-500 rounded-xl border border-gray-300 hover:text-red-500"><Icons.Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 paper-texture">
                                        <div className="bg-white/90 rounded-2xl p-3 border-2 border-gray-100 shadow-sm">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#0097A7] font-bold text-lg"><Icons.Clock size={24}/> è©³ç´°è¡Œç¨‹</div><button onClick={() => addScheduleItem(day.id)} className="text-[#0097A7] bg-[#E0F7FA] px-2 py-1 rounded-lg text-sm font-bold border border-[#B2EBF2]">+ æ–°å¢ž</button></div>
                                            {/* UPDATED SCHEDULE ITEM RENDER */}
                                            <div className="space-y-2">
                                                {day.schedule && day.schedule.map(item => (
                                                    <div key={item.id} 
                                                        className={`flex gap-2 items-start bg-gray-50 p-2 rounded-xl border border-gray-200 transition-all ${editingScheduleId === item.id ? 'scale-105 shadow-lg border-[#FF6B6B] bg-red-50 z-10' : ''}`}
                                                        onTouchStart={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} 
                                                        onTouchEnd={() => clearTimeout(item.timer)} 
                                                        onMouseDown={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} 
                                                        onMouseUp={() => clearTimeout(item.timer)}
                                                    >
                                                    <div className="flex flex-col gap-1 items-center">
                                                        <input value={item.time} onChange={(e) => updateScheduleItem(day.id, item.id, 'time', e.target.value)} className="w-16 bg-white border border-gray-300 rounded-lg p-1 text-sm font-bold text-center outline-none" type="time" />
                                                        
                                                        {/* Link Expense Button */}
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); linkScheduleToExpense(day.id, item.id); }}
                                                            className={`p-1 rounded-full border ${item.expenseId ? 'bg-[#FF9F43] text-white border-[#E65100]' : 'bg-white text-gray-300 border-gray-200'}`}
                                                        >
                                                            <Icons.Coins size={14}/>
                                                        </button>

                                                        {editingScheduleId === item.id && (
                                                            <div className="flex flex-col gap-1">
                                                                <button onClick={() => moveScheduleItem(day.id, item.id, 'up')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowUp size={12}/></button>
                                                                <button onClick={() => moveScheduleItem(day.id, item.id, 'down')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowDown size={12}/></button>
                                                                <button onClick={() => setEditingScheduleId(null)} className="text-[10px] text-blue-500 font-bold">å®Œæˆ</button>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="flex-1 space-y-1">
                                                        <div className="flex gap-1">
                                                            <select value={item.category} onChange={(e) => updateScheduleItem(day.id, item.id, 'category', e.target.value)} className="bg-white border border-gray-300 rounded-lg p-1 text-xs font-bold w-20 outline-none">{SCHEDULE_CATEGORIES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}</select>
                                                            <input value={item.activity} onChange={(e) => updateScheduleItem(day.id, item.id, 'activity', e.target.value)} className="flex-1 bg-transparent border-b border-dashed border-gray-300 outline-none text-base font-bold text-gray-800" placeholder="åšä»€éº¼..." />
                                                        </div>
                                                        <input value={item.note} onChange={(e) => updateScheduleItem(day.id, item.id, 'note', e.target.value)} className="w-full bg-transparent outline-none text-xs text-gray-500" placeholder="å‚™è¨»..." />
                                                    </div>
                                                    <button onClick={() => removeScheduleItem(day.id, item.id)} className="text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-3"><div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#455A64] font-bold text-sm mb-1"><Icons.Train size={18}/> äº¤é€š</div><input value={day.transport} onChange={(e) => updateItinerary(day.id, 'transport', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="æ­è»Š..." /></div><div className="flex-1 bg-white/90 rounded-2xl p-2 border-2 border-gray-100 shadow-sm"><div className="flex items-center gap-1 text-[#5C6BC0] font-bold text-sm mb-1"><Icons.Home size={18}/> ä½å®¿</div><input value={day.stay} onChange={(e) => updateItinerary(day.id, 'stay', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="é£¯åº—..." /></div></div>
                                        <div className="bg-[#FFF8E1] rounded-2xl p-3 border-2 border-[#FFE0B2] shadow-sm">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#F57C00] font-bold text-lg"><Icons.Coins size={22}/> æœ¬æ—¥å¸³æœ¬</div><span className="text-sm font-black text-[#F57C00]">${dayTotal.toLocaleString()}</span></div>
                                            <div className="space-y-1 mb-2">{expenses.filter(e => e.date === day.date).map(e => (<div key={e.id} className="flex justify-between text-xs text-gray-600 border-b border-dashed border-gray-300 pb-1"><span>{e.item}</span><span className="font-bold">{CURRENCIES.find(c => c.code === e.currency)?.symbol}{e.amount}</span></div>))}</div>
                                            <button onClick={() => { setNewExpense({...newExpense, date: day.date}); setShowExpenseModal(true); }} className="w-full bg-[#FF9F43] text-white py-2 rounded-xl font-bold text-sm shadow-sm active:scale-95 transition-transform">+ è¨˜ä¸€ç­†</button>
                                        </div>
                                        <div className="pt-1"><div className="flex items-center gap-2 text-gray-500 font-bold text-sm mb-2"><Icons.Camera size={18}/> æ‰“å¡ / ç…§ç‰‡æ—¥è¨˜</div><div onClick={() => triggerFileAction('photo', day.id)} className="w-full h-40 rounded-2xl border-4 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-white/50 overflow-hidden relative bg-white/30 group transition-all">{day.photo ? <img src={day.photo} alt="Daily" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-gray-400 group-hover:text-[#FF6B6B] transition-colors"><Icons.Image size={32}/><span className="text-xs font-bold mt-1">é»žæ“Šä¸Šå‚³</span></div>}</div></div>
                                    </div>
                                    <div className="p-3 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center shrink-0"><button onClick={(e) => openGoogleMaps(e, day.content)} className="w-full bg-[#E0F7FA] text-[#00BCD4] px-4 py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-1 hover:bg-[#B2EBF2] border border-[#B2EBF2]"><Icons.Navigation size={16}/> Google Maps å°Žèˆª</button></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
                <FloatingActionButton />
              </div>
            )}

            {/* Expenses Tab - V23 Optimized Layout */}
            {activeTab === 'expenses' && (
              <div className="h-full flex flex-col pt-4 overflow-hidden relative">
                
                {/* 1. Dashboard */}
                <div className="px-4 pb-2">
                    <div className="bg-[#FFF8E1] p-3 rounded-2xl border-2 border-[#FFE0B2] shadow-sm flex justify-between items-center">
                        <div><div className="text-xs text-[#F57C00] font-bold">ç¸½èŠ±è²» (å°å¹£)</div><div className="text-2xl font-black text-[#E65100]">${totalSpentConvertedTWD.toLocaleString()}</div></div>
                        <div className="text-right"><div className="text-xs text-[#F57C00] font-bold">ç´„åˆæ—¥å¹£</div><div className="text-xl font-black text-[#FF9800]">Â¥{Math.round(totalSpentConvertedTWD / getExchangeRate('JPY')).toLocaleString()}</div></div>
                    </div>
                </div>

                {/* 2. V23 Input Panel Moved to Top */}
                <div className="px-4 mb-2">
                    <div className="bg-white rounded-2xl shadow-md border-2 border-[#FF6B6B] p-3">
                        {/* Platform Manager */}
                        {showPlatformManager && (
                            <div className="mb-3 p-2 bg-gray-50 rounded-xl border border-gray-200">
                                <div className="flex justify-between mb-2"><h4 className="text-xs font-bold text-gray-600">ç®¡ç†å¹³å°</h4><button onClick={() => setShowPlatformManager(false)}><Icons.X size={16}/></button></div>
                                <div className="flex gap-2 mb-2"><input value={newPlatformName} onChange={e => setNewPlatformName(e.target.value)} placeholder="æ–°å¢ž..." className="flex-1 bg-white border border-gray-300 rounded px-2 py-1 text-sm"/><button onClick={addBookingPlatform} className="bg-[#4ECDC4] text-white px-2 rounded text-xs font-bold">æ–°å¢ž</button></div>
                                <div className="flex flex-wrap gap-1 max-h-20 overflow-y-auto">{bookingPlatforms.map(p => (<div key={p} className="bg-white border px-2 py-0.5 rounded text-[10px] font-bold flex items-center gap-1">{p} <button onClick={() => deleteBookingPlatform(p)} className="text-red-400"><Icons.X size={10}/></button></div>))}</div>
                            </div>
                        )}
                        
                        {/* Row 1: Date */}
                        <div className="mb-2">
                             <select value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="w-full bg-gray-50 rounded-lg px-2 py-2 outline-none text-sm font-bold border border-gray-200">{itinerary.map(d => <option key={d.id} value={d.date}>{formatDate(d.date)} ({getWeekday(d.date)})</option>)}</select>
                        </div>

                        {/* Row 2: Category + Item */}
                        <div className="flex gap-2 mb-2">
                             <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="bg-gray-50 rounded-lg px-2 py-2 outline-none text-sm font-bold w-1/3 border border-gray-200">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                             <input type="text" placeholder="å“é …..." value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="flex-1 bg-transparent border-b-2 border-dashed border-gray-300 outline-none text-base font-bold text-gray-800 h-10 px-1" />
                        </div>

                        {/* Row 3: Method + Platform */}
                        <div className="flex gap-2 mb-2">
                             <select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="bg-gray-50 rounded-lg px-2 py-2 outline-none text-xs font-bold flex-1 border border-gray-200 text-gray-500">{paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}</select>
                             <div className="relative flex-1">
                                <select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="w-full bg-gray-50 rounded-lg pl-2 pr-6 py-2 outline-none text-xs font-bold border border-gray-200 appearance-none h-10">{bookingPlatforms.map(p => <option key={p} value={p}>{p}</option>)}</select>
                                <button onClick={() => setShowPlatformManager(!showPlatformManager)} className="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 p-1"><Icons.Settings size={12}/></button>
                             </div>
                        </div>

                        {/* Row 4: Amount | Currency | Button */}
                        <div className="flex gap-2 items-center">
                            <button onClick={() => triggerFileAction('receipt')} className="bg-[#E0F2F1] text-[#00695C] w-12 h-12 rounded-xl border-2 border-[#80CBC4] shadow-sm active:scale-95 transition-transform flex items-center justify-center shrink-0"><Icons.Camera size={24}/></button>
                            <div className="flex-1 flex items-center bg-gray-50 rounded-lg border-2 border-[#FFCCBC] px-2 h-12">
                                <input type="number" placeholder="é‡‘é¡" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} className="w-full bg-transparent font-black text-2xl outline-none text-[#E64A19]" />
                                <select value={newExpense.currency} onChange={e => setNewExpense({...newExpense, currency: e.target.value})} className="bg-transparent outline-none font-bold text-xs w-10 text-gray-500 text-right">{CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.label.split(' ')[0]}</option>)}</select>
                            </div>
                            <button onClick={handleDirectAddExpense} className="bg-[#FF9F43] text-white w-12 h-12 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center shrink-0"><Icons.Plus size={28}/></button>
                        </div>
                    </div>
                </div>

                {/* 3. List Area (Now takes remaining space) */}
                <div className="flex-1 overflow-y-auto no-scrollbar pb-24 px-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {(expenseFilter === 'all' ? expenses : expenses.filter(e => e.date === expenseFilter)).slice().reverse().map(expense => (
                        <div key={expense.id} className="bg-white p-3 rounded-2xl border-2 border-gray-100 shadow-sm flex justify-between items-center h-20 animate-in fade-in slide-in-from-bottom-2">
                        <div className="flex-1 overflow-hidden"><div className="text-xs text-gray-500 font-bold mb-1">{formatDate(expense.date)} â€¢ {expense.category}</div><div className="text-lg font-bold text-gray-900 truncate pr-2">{expense.item}</div><div className="text-xs text-gray-400 font-bold mt-1">{expense.method} {expense.platform ? `/ ${expense.platform}` : ''}</div></div>
                        <div className="text-right shrink-0"><div className="text-xl font-bold text-[#FF9F43]">{CURRENCIES.find(c => c.code === expense.currency)?.symbol}{expense.amount.toLocaleString()}</div>{expense.currency !== 'TWD' && <div className="text-xs text-gray-400 font-bold">â‰ˆ ${Math.round(expense.amount * getExchangeRate(expense.currency))}</div>}<button onClick={() => handleDeleteExpense(expense.id)} className="text-gray-300 hover:text-red-400 mt-1 p-2"><Icons.Trash2 size={16} /></button></div></div>
                    ))}
                    </div>
                </div>
              </div>
            )}

            {activeTab === 'shopping' && (
              <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                <div className="flex gap-2 text-white mb-4">
                    <div className="flex-1 bg-[#FF6B81] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ðŸ™†â€â™€ï¸ è‡ªç”¨</div><div className="font-bold text-2xl">Â¥{shoppingStats.selfTotal.toLocaleString()}</div></div>
                    <div className="flex-1 bg-[#6C5CE7] p-3 rounded-2xl border-2 border-black shadow-md"><div className="text-sm font-bold opacity-90">ðŸ“¦ ä»£è³¼æ”¶</div><div className="font-bold text-2xl text-white">${Math.round(shoppingStats.agentTotal * getExchangeRate('JPY')).toLocaleString()}</div></div>
                </div>

                {/* V23 Agent Summary Card */}
                {Object.keys(agentSummary).length > 0 && (
                    <div className="bg-[#E8EAF6] p-4 rounded-2xl border-2 border-[#C5CAE9] mb-4 shadow-sm">
                        <h3 className="font-bold text-[#3949AB] mb-2 flex items-center gap-2"><Icons.Coins size={20}/> ä»£è³¼çµç®— (æ¯äººç¸½è¨ˆ)</h3>
                        <div className="space-y-2">
                            {Object.entries(agentSummary).map(([name, totals]) => (
                                <div key={name} className="flex justify-between items-center bg-white/60 p-2 rounded-xl">
                                    <span className="font-bold text-gray-700">{name}</span>
                                    <div className="text-right">
                                        <div className="text-sm font-bold text-gray-500">Â¥{totals.jpy.toLocaleString()}</div>
                                        <div className="text-lg font-black text-[#3949AB]">${totals.twd.toLocaleString()}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                <div className="bg-white p-5 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                    <div className="flex bg-gray-100 p-1 rounded-xl mb-3 border-2 border-gray-200">
                        {['self', 'agent', 'split'].map(type => ( <button key={type} onClick={() => setNewShopItem({...newShopItem, type})} className={`flex-1 py-2 rounded-lg text-lg font-bold transition-all ${newShopItem.type === type ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{type === 'self' ? 'è‡ªç”¨' : type === 'agent' ? 'ä»£è³¼' : 'åˆ†å¸³'}</button> ))}
                    </div>
                    <div className="flex gap-2 mb-2"><button onClick={() => { setBatchType('shopping'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 rounded-xl font-bold mb-1 border-2 border-[#80CBC4] flex items-center justify-center gap-2"><Icons.ListPlus size={20}/> æ‰¹æ¬¡åŒ¯å…¥</button></div>
                    <div className="flex gap-3 mb-3">
                        <select value={newShopItem.priority} onChange={e => setNewShopItem({...newShopItem, priority: e.target.value})} className="bg-gray-50 border-2 border-gray-200 rounded-xl px-2 outline-none text-base font-bold w-32"><option value="high">ðŸ”´ å¿…è²·</option><option value="medium">ðŸŸ¡ é¸è³¼</option><option value="low">ðŸŸ¢ å¯è²·</option></select>
                        <input placeholder="æˆ°åˆ©å“åç¨±..." value={newShopItem.item} onChange={e => setNewShopItem({...newShopItem, item: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none font-bold text-xl text-gray-800" />
                    </div>
                    <div className="flex gap-3 mb-3"><input type="number" placeholder="æ—¥å¹£ Â¥" value={newShopItem.budget} onChange={e => setNewShopItem({...newShopItem, budget: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-3 outline-none text-xl font-bold" /></div>
                    {(newShopItem.type === 'agent' || newShopItem.type === 'split') && ( <div className="flex gap-3 mb-3 animate-in fade-in">{newShopItem.type === 'agent' && <input placeholder="å¹«èª°è²·?" value={newShopItem.note} onChange={e => setNewShopItem({...newShopItem, note: e.target.value})} className="flex-1 bg-[#EDE7F6] border-2 border-[#6C5CE7] rounded-xl px-4 py-3 outline-none text-[#6C5CE7] font-bold text-lg" />}{newShopItem.type === 'split' && <div className="flex-1 flex items-center bg-[#FFF3E0] border-2 border-[#FFA502] rounded-xl px-4 text-[#FFA502] font-bold"><span className="text-sm mr-2">äººæ•¸:</span><input type="number" value={newShopItem.splitCount} onChange={e => setNewShopItem({...newShopItem, splitCount: e.target.value})} className="w-full bg-transparent outline-none text-xl" /></div>}</div> )}
                    <button onClick={handleAddShoppingItem} className="w-full bg-[#FF6B81] text-white py-3 rounded-2xl border-2 border-black korean-3d-btn font-bold text-xl flex items-center justify-center gap-2 mt-2"><Icons.Plus size={24}/> åŠ å…¥æ¸…å–®</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {shoppingList.filter(i => !i.bought).map(item => (
                    <div key={item.id} className="bg-white p-4 rounded-2xl border-4 shadow-sm flex items-center justify-between" style={{ borderColor: item.type === 'agent' ? '#6C5CE7' : item.type === 'split' ? '#FFA502' : '#FF6B81' }}>
                        <div className="flex items-center gap-4 cursor-pointer w-full" onClick={() => toggleShoppingItem(item.id)}>
                            <div className={`w-4 h-full self-stretch rounded-full ${item.type === 'agent' ? 'bg-[#6C5CE7]' : item.type === 'split' ? 'bg-[#FFA502]' : 'bg-[#FF6B81]'}`}></div>
                            <div className="flex-1 overflow-hidden">
                                <div className="flex items-center gap-2"><span className={`text-xs px-2 py-1 rounded-lg shrink-0 text-white font-bold shadow-sm ${item.priority === 'high' ? 'bg-red-500' : item.priority === 'medium' ? 'bg-yellow-400' : 'bg-green-400'}`}>{item.priority === 'high' ? 'å¿…è²·' : item.priority === 'medium' ? 'é¸è³¼' : 'å¯è²·'}</span><span className="font-bold text-xl text-gray-800 truncate">{item.item}</span></div>
                                <div className="text-sm text-gray-500 font-bold mt-1 flex items-center gap-2">
                                    <span className="bg-gray-100 px-2 rounded">Â¥{item.budget.toLocaleString()}</span>
                                    <span className="text-gray-300">âžœ</span>
                                    <span className="text-gray-900 font-bold text-lg">{item.type === 'split' ? `$${Math.round((item.budget * getExchangeRate('JPY')) / item.splitCount)} /äºº` : `$${Math.round(item.budget * getExchangeRate('JPY'))}`}</span>
                                    {/* Link Indicator */}
                                    {item.expenseId && <span className="text-[10px] bg-orange-100 text-orange-600 px-1 rounded border border-orange-200">å·²è¨˜å¸³</span>}
                                </div>
                                {(item.type === 'agent' || item.type === 'split') && ( <div className="text-xs font-bold text-gray-400 mt-2 bg-gray-50 w-fit px-2 py-1 rounded">{item.type === 'agent' ? `çµ¦: ${item.note}` : `${item.splitCount}äººåˆ†å¸³`}</div> )}
                            </div>
                        </div>
                        <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 p-2 shrink-0 hover:text-red-400"><Icons.Trash2 size={24}/></button>
                    </div>
                  ))}
                </div>
                {shoppingList.filter(i => i.bought).length > 0 && <div className="text-gray-400 text-lg font-bold mt-6 mb-3 border-b-2 border-gray-200 pb-1">å·²è³¼è²·å®Œæˆ</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">{shoppingList.filter(i => i.bought).map(item => (<div key={item.id} onClick={() => toggleShoppingItem(item.id)} className="bg-gray-100 p-3 rounded-xl border-2 border-gray-200 flex items-center gap-3 opacity-60"><Icons.Check size={20} className="text-gray-500"/><span className="line-through text-gray-500 font-bold text-lg">{item.item}</span></div>))}</div>
              </div>
            )}
            
            {activeTab === 'packing' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                    {/* Add Category Section */}
                    <div className="bg-white p-4 rounded-3xl shadow-lg border-2 border-gray-100 mb-6">
                        <div className="flex gap-2">
                            <input value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="æ–°å¢žåˆ†é¡žåç¨± (å¦‚: æ”å½±è£å‚™)..." className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-4 py-2 outline-none font-bold text-lg" />
                            <button onClick={addPackingCategory} className="bg-[#6C5CE7] text-white px-4 rounded-xl font-bold flex items-center"><Icons.Plus size={20}/> åˆ†é¡ž</button>
                        </div>
                    </div>
                    
                    <div className="space-y-6">
                        {packingCategories.map(cat => {
                            const items = packingList.filter(i => i.category === cat);
                            return (
                                <div key={cat} className="animate-in fade-in slide-in-from-bottom-2">
                                    <div className="flex justify-between items-center mb-3 ml-2">
                                        <h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><span className="w-2 h-6 bg-[#FF6B6B] rounded-full"></span>{cat}</h3>
                                        <div className="flex gap-2">
                                            {/* Add Item to Category Toggle */}
                                            <button onClick={() => setActivePackingCategory(activePackingCategory === cat ? null : cat)} className={`p-1 rounded-lg border-2 ${activePackingCategory === cat ? 'bg-[#FF6B6B] text-white border-[#FF6B6B]' : 'bg-white text-gray-400 border-gray-300'}`}><Icons.Plus size={18}/></button>
                                            <button onClick={() => deletePackingCategory(cat)} className="text-gray-300 hover:text-red-400 p-1"><Icons.Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                    
                                    {/* Inline Add Item Form */}
                                    {activePackingCategory === cat && (
                                        <div className="flex gap-2 mb-3 px-1">
                                            <input autoFocus value={newPackingItemText} onChange={e => setNewPackingItemText(e.target.value)} placeholder={`æ–°å¢žç‰©å“åˆ° ${cat}...`} className="flex-1 bg-white border-2 border-[#FF6B6B] rounded-xl px-3 py-2 outline-none font-bold text-lg" />
                                            <button onClick={() => addPackingItemToCategory(cat)} className="bg-[#FF6B6B] text-white px-4 rounded-xl font-bold">åŠ å…¥</button>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {items.map(item => (
                                            <div key={item.id} onClick={() => togglePackingItem(item.id)} className={`p-4 rounded-2xl border-2 flex items-center justify-between transition-all cursor-pointer ${item.checked ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-200 shadow-sm'}`}>
                                                <div className="flex items-center gap-4"><div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.checked ? 'bg-[#4ECDC4] border-[#4ECDC4]' : 'border-gray-300'}`}>{item.checked && <Icons.Check size={16} className="text-white"/>}</div><span className={`text-xl font-thin-hand ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}`}>{item.item}</span></div>
                                                <button onClick={(e) => { e.stopPropagation(); deletePackingItem(item.id); }} className="text-gray-300 hover:text-red-400 p-2"><Icons.Trash2 size={20}/></button>
                                            </div>
                                        ))}
                                        {items.length === 0 && <div className="text-gray-400 text-sm italic p-2">æš«ç„¡ç‰©å“</div>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )}
            
            {activeTab === 'info' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar space-y-4">
                    {/* Useful Links & Emergency - Compact Row */}
                    <div className="grid grid-cols-2 gap-3">
                         <div className="space-y-2">
                             <a href="https://www.vjw.digital.go.jp/" target="_blank" className="bg-white p-2 rounded-xl border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50"><span className="text-xl">ðŸ‡¯ðŸ‡µ</span><span className="text-blue-600 font-bold text-sm">VJW å…¥å¢ƒ</span></a>
                             <a href="https://tenki.jp/" target="_blank" className="bg-white p-2 rounded-xl border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50"><span className="text-xl">ðŸŒ¤ï¸</span><span className="text-blue-600 font-bold text-sm">å¤©æ°£ Tenki.jp</span></a>
                             <a href="https://www.google.com/finance/quote/JPY-TWD" target="_blank" className="bg-white p-2 rounded-xl border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50"><span className="text-xl">ðŸ’°</span><span className="text-blue-600 font-bold text-sm">å³æ™‚åŒ¯çŽ‡</span></a>
                         </div>
                         <div className="bg-[#FFEBEE] p-3 rounded-xl border border-[#FFCDD2] flex flex-col justify-between">
                            <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-700">ðŸ‘® å ±è­¦</span><a href="tel:110" className="text-red-600 font-black">110</a></div>
                            <div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-700">ðŸš‘ æ•‘è­·</span><a href="tel:119" className="text-red-600 font-black">119</a></div>
                            <div className="flex justify-between items-center"><span className="text-xs font-bold text-gray-700">ðŸ‡¹ðŸ‡¼ å¤§é˜ªè¾¦äº‹è™•</span><a href="tel:+81-90-8794-4568" className="text-red-600 font-black text-xs">å°ˆç·š</a></div>
                         </div>
                    </div>

                    {/* V26 Accommodation Section - Added Date */}
                    <div className="bg-[#E8EAF6] rounded-2xl p-4 border-2 border-[#C5CAE9]">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-xl text-[#3949AB] flex items-center gap-2"><Icons.Bed size={22}/> ä½å®¿æƒ…å ±</h3>
                            <button onClick={() => setShowAddHotel(!showAddHotel)} className="bg-[#3949AB] text-white px-3 py-1 rounded-lg text-sm font-bold">{showAddHotel ? 'å–æ¶ˆ' : '+ æ–°å¢ž'}</button>
                        </div>
                        
                        {showAddHotel && (
                            <div className="bg-white p-3 rounded-xl mb-3 animate-in fade-in">
                                <div className="flex flex-col gap-1 mb-2">
                                     <label className="text-xs text-gray-500 font-bold">Check-in æ—¥æœŸ</label>
                                     <input type="date" value={newHotel.date} onChange={e => setNewHotel({...newHotel, date: e.target.value})} className="border-b outline-none font-bold w-full" />
                                </div>
                                <input placeholder="é£¯åº—åç¨±" value={newHotel.name} onChange={e => setNewHotel({...newHotel, name: e.target.value})} className="w-full border-b mb-2 outline-none font-bold text-lg" />
                                <input placeholder="åœ°å€ (ä¾›å°Žèˆªç”¨)" value={newHotel.address} onChange={e => setNewHotel({...newHotel, address: e.target.value})} className="w-full border-b mb-2 outline-none text-sm" />
                                <input placeholder="è¨‚å–®ç·¨è™Ÿ/é›»è©±/å‚™è¨»" value={newHotel.note} onChange={e => setNewHotel({...newHotel, note: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" />
                                <button onClick={handleAddHotel} className="w-full bg-[#3949AB] text-white py-2 rounded-lg font-bold">å„²å­˜é£¯åº—</button>
                            </div>
                        )}

                        <div className="space-y-2">
                            {accommodations.sort((a,b) => new Date(a.date) - new Date(b.date)).map(h => (
                                <div key={h.id} className="bg-white p-3 rounded-xl shadow-sm border border-[#C5CAE9] relative">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            {h.date && <div className="text-xs font-bold text-[#3949AB] bg-[#E8EAF6] w-fit px-2 rounded mb-1">{formatDate(h.date)} ({getWeekday(h.date)}) Check-in</div>}
                                            <div className="font-bold text-lg text-gray-800 pr-6">{h.name}</div>
                                        </div>
                                    </div>
                                    {h.address && <button onClick={(e) => openGoogleMaps(e, h.address)} className="text-blue-500 text-xs font-bold underline flex items-center gap-1 my-1"><Icons.Map size={12}/> {h.address}</button>}
                                    {h.note && <div className="text-sm text-gray-500 bg-gray-50 p-1 rounded mt-1">ðŸ“ {h.note}</div>}
                                    <button onClick={() => handleDeleteHotel(h.id)} className="absolute top-2 right-2 text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                            {accommodations.length === 0 && <div className="text-center text-gray-400 text-sm py-2">å°šæœªæ–°å¢žä½å®¿</div>}
                        </div>
                    </div>

                    {/* V26 Transport/Reservation Section - Clarity Improved */}
                    <div className="bg-[#E0F2F1] rounded-2xl p-4 border-2 border-[#80CBC4]">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-xl text-[#00695C] flex items-center gap-2"><Icons.Ticket size={22}/> é ç´„è»Šè¨Š</h3>
                            <button onClick={() => setShowAddReserv(!showAddReserv)} className="bg-[#00695C] text-white px-3 py-1 rounded-lg text-sm font-bold">{showAddReserv ? 'å–æ¶ˆ' : '+ æ–°å¢ž'}</button>
                        </div>

                         {showAddReserv && (
                            <div className="bg-white p-3 rounded-xl mb-3 animate-in fade-in">
                                <input placeholder="é ç´„é …ç›® (å¦‚: Harukaè»Šç¥¨)" value={newReserv.title} onChange={e => setNewReserv({...newReserv, title: e.target.value})} className="w-full border-b mb-2 outline-none font-bold" />
                                <div className="flex flex-col gap-1 mb-2">
                                    <label className="text-xs text-gray-500 font-bold">æ—¥æœŸèˆ‡æ™‚é–“</label>
                                    <input type="datetime-local" value={newReserv.time} onChange={e => setNewReserv({...newReserv, time: e.target.value})} className="w-full border-b outline-none text-sm" />
                                </div>
                                <input placeholder="é ç´„ä»£è™Ÿ / åº§ä½ / å‚™è¨»" value={newReserv.code} onChange={e => setNewReserv({...newReserv, code: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" />
                                <button onClick={handleAddReserv} className="w-full bg-[#00695C] text-white py-2 rounded-lg font-bold">å„²å­˜é ç´„</button>
                            </div>
                        )}

                        <div className="space-y-2">
                            {reservations.sort((a,b) => new Date(a.time) - new Date(b.time)).map(r => (
                                <div key={r.id} className="bg-white p-3 rounded-xl shadow-sm border border-[#80CBC4] relative">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            {r.time && <div className="text-xs font-bold bg-[#B2DFDB] text-[#00695C] px-2 py-1 rounded h-fit mb-1">{new Date(r.time).toLocaleString([], {month:'numeric', day:'numeric', weekday:'short', hour:'2-digit', minute:'2-digit'})}</div>}
                                            <div className="font-bold text-gray-800">{r.title}</div>
                                        </div>
                                    </div>
                                    {r.code && <div className="text-lg font-mono font-bold text-gray-600 mt-1 tracking-wider">{r.code}</div>}
                                    <button onClick={() => handleDeleteReserv(r.id)} className="absolute bottom-2 right-2 text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                             {reservations.length === 0 && <div className="text-center text-gray-400 text-sm py-2">å°šæœªæ–°å¢žé ç´„</div>}
                        </div>
                    </div>

                    {/* V30 Gourmet Collection - NEW FEATURE */}
                    <div className="bg-[#FFF3E0] rounded-2xl p-4 border-2 border-[#FFE0B2]">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-xl text-[#E65100] flex items-center gap-2"><Icons.Utensils size={22}/> ç¾Žé£Ÿç‰¹æœ</h3>
                            <div className="flex gap-2">
                                {/* V34 AI Gourmet Button */}
                                <button onClick={openAIGourmet} className="sparkle-btn px-2 py-1 rounded-lg text-sm font-bold shadow flex items-center gap-1"><Icons.Sparkles size={14}/> AI æŽ¨è–¦</button>
                                <button onClick={() => setShowAddGourmet(!showAddGourmet)} className="bg-[#E65100] text-white px-3 py-1 rounded-lg text-sm font-bold">{showAddGourmet ? 'å–æ¶ˆ' : '+ æ–°å¢ž'}</button>
                            </div>
                        </div>

                         {showAddGourmet && (
                            <div className="bg-white p-3 rounded-xl mb-3 animate-in fade-in border-2 border-[#FFCCBC]">
                                <div className="flex gap-2 mb-2">
                                    <select value={newGourmet.city} onChange={e => setNewGourmet({...newGourmet, city: e.target.value})} className="bg-gray-50 rounded p-1 text-sm font-bold outline-none">{CITIES.map(c => <option key={c} value={c}>{c}</option>)}</select>
                                    <input placeholder="åº—å (å¦‚: ç‡’è‚‰åŠ›ä¸¸)" value={newGourmet.name} onChange={e => setNewGourmet({...newGourmet, name: e.target.value})} className="flex-1 border-b outline-none font-bold" />
                                </div>
                                <input placeholder="åœ°é»ž/åˆ†åº— (ä¾›å°Žèˆªç”¨)" value={newGourmet.location} onChange={e => setNewGourmet({...newGourmet, location: e.target.value})} className="w-full border-b mb-2 outline-none text-sm" />
                                <div onClick={() => triggerFileAction('gourmetPhoto', 'new')} className="w-full h-24 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center mb-2 cursor-pointer overflow-hidden">
                                    {newGourmet.photo ? <img src={newGourmet.photo} className="w-full h-full object-cover"/> : <span className="text-gray-400 text-xs flex items-center gap-1"><Icons.Camera size={14}/> ä¸Šå‚³ç¾Žé£Ÿç…§</span>}
                                </div>
                                <input placeholder="å¿…åƒ/å‚™è¨»..." value={newGourmet.note} onChange={e => setNewGourmet({...newGourmet, note: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" />
                                <button onClick={handleAddGourmet} className="w-full bg-[#E65100] text-white py-2 rounded-lg font-bold">åŠ å…¥æ¸…å–®</button>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-3">
                            {gourmetList.map(g => (
                                <div key={g.id} className="bg-white rounded-xl shadow-sm border border-[#FFE0B2] overflow-hidden relative flex flex-col">
                                    <div onClick={() => triggerFileAction('gourmetPhoto', g.id)} className="h-24 bg-gray-100 w-full relative group cursor-pointer">
                                        {g.photo ? <img src={g.photo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icons.Utensils size={30}/></div>}
                                        <div className="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold text-xs">æ›´æ›ç…§ç‰‡</div>
                                        <span className="absolute top-1 left-1 bg-black/50 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur-sm">{g.city}</span>
                                    </div>
                                    <div className="p-2 flex-1 flex flex-col">
                                        <div className="font-bold text-gray-800 text-sm mb-1 leading-tight">{g.name}</div>
                                        {g.location && <button onClick={(e) => openGoogleMaps(e, g.location)} className="text-blue-500 text-[10px] font-bold underline flex items-center gap-1 mb-1"><Icons.Map size={10}/> {g.location}</button>}
                                        {g.note && <div className="text-[10px] text-gray-500 bg-gray-50 p-1 rounded mt-auto">{g.note}</div>}
                                    </div>
                                    <button onClick={() => handleDeleteGourmet(g.id)} className="absolute top-1 right-1 text-white drop-shadow-md hover:text-red-400"><Icons.Trash2 size={16}/></button>
                                </div>
                            ))}
                        </div>
                         {gourmetList.length === 0 && <div className="text-center text-gray-400 text-sm py-2">å¿«ä¾†æœé›†ç¾Žé£Ÿï¼</div>}
                    </div>

                    {/* Free Memo */}
                    <div className="flex-1 flex flex-col">
                        <h3 className="font-bold text-xl text-gray-800 mb-2 flex items-center gap-2"><Icons.ListPlus size={24}/> è‡ªç”±å‚™å¿˜éŒ„</h3>
                        <textarea 
                            className="w-full h-40 bg-[#FFFDE7] border-2 border-[#FFF59D] rounded-2xl p-4 text-gray-700 font-bold text-lg outline-none resize-none shadow-sm leading-relaxed" 
                            placeholder="åœ¨é€™è£¡è²¼ä¸Šèˆªç­è³‡è¨Šã€é£¯åº—åœ°å€ã€æˆ–æ˜¯ä»»ä½•æƒ³è¨˜ä¸‹ä¾†çš„äº‹æƒ…..." 
                            value={memoContent}
                            onChange={(e) => setMemoContent(e.target.value)}
                        ></textarea>
                    </div>
                </div>
            )}
          </div>

          <div className="bg-white border-t-2 border-gray-100 shrink-0 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] grid grid-cols-5 gap-1 p-2 h-20 items-end pb-4 z-50 relative">
            <TabButton id="itinerary" IconComp={Icons.Map} label="è¡Œç¨‹" bgColor="#FFECF2" activeColor="#FF6B81" />
            <TabButton id="expenses" IconComp={Icons.Coins} label="è¨˜å¸³" bgColor="#FFF8E1" activeColor="#FFB74D" />
            <TabButton id="shopping" IconComp={Icons.ShoppingBag} label="æˆ°åˆ©å“" bgColor="#E0F2F1" activeColor="#4DB6AC" />
            <TabButton id="packing" IconComp={Icons.Suitcase} label="è¡ŒæŽ" bgColor="#F3E5F5" activeColor="#BA68C8" />
            <TabButton id="info" IconComp={Icons.Info} label="è³‡è¨Š" bgColor="#E3F2FD" activeColor="#64B5F6" />
          </div>

        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
